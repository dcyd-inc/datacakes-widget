/*! For license information please see datacakes-bot.js.LICENSE.txt */
(()=>{var t={234:(t,e,g)=>{var i,n;void 0===(n="function"==typeof(i=function(){"use strict";function t(){}const e=t=>t;function i(t){return t()}function n(){return Object.create(null)}function I(t){t.forEach(i)}function C(t){return"function"==typeof t}function o(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function s(t,e){return t!=t?e==e:t!==e}function A(t){return 0===Object.keys(t).length}const a="undefined"!=typeof window;let c=a?()=>window.performance.now():()=>Date.now(),l=a?t=>requestAnimationFrame(t):t;const d=new Set;function r(t){d.forEach((e=>{e.c(t)||(d.delete(e),e.f())})),0!==d.size&&l(r)}function h(t){let e;return 0===d.size&&l(r),{promise:new Promise((g=>{d.add(e={c:t,f:g})})),abort(){d.delete(e)}}}function u(t,e){t.appendChild(e)}function b(t,e,g){const i=p(t);if(!i.getElementById(e)){const t=v("style");t.id=e,t.textContent=g,Z(i,t)}}function p(t){if(!t)return document;const e=t.getRootNode?t.getRootNode():t.ownerDocument;return e&&e.host?e:t.ownerDocument}function m(t){const e=v("style");return Z(p(t),e),e.sheet}function Z(t,e){return u(t.head||t,e),e.sheet}function G(t,e,g){t.insertBefore(e,g||null)}function y(t){t.parentNode&&t.parentNode.removeChild(t)}function v(t){return document.createElement(t)}function W(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function w(t){return document.createTextNode(t)}function V(){return w(" ")}function R(){return w("")}function f(t,e,g,i){return t.addEventListener(e,g,i),()=>t.removeEventListener(e,g,i)}function B(t,e,g){null==g?t.removeAttribute(e):t.getAttribute(e)!==g&&t.setAttribute(e,g)}function X(t,e,g){e in t?t[e]="boolean"==typeof t[e]&&""===g||g:B(t,e,g)}function S(t,e,g,i){null===g?t.style.removeProperty(e):t.style.setProperty(e,g,i?"important":"")}function N(t,e,g){t.classList[g?"add":"remove"](e)}function Y(t){const e={};for(const g of t)e[g.name]=g.value;return e}const z=new Map;let x,F=0;function k(t,e,g,i,n,I,C,o=0){const s=16.666/i;let A="{\n";for(let t=0;t<=1;t+=s){const i=e+(g-e)*I(t);A+=100*t+`%{${C(i,1-i)}}\n`}const a=A+`100% {${C(g,1-g)}}\n}`,c=`__svelte_${function(t){let e=5381,g=t.length;for(;g--;)e=(e<<5)-e^t.charCodeAt(g);return e>>>0}(a)}_${o}`,l=p(t),{stylesheet:d,rules:r}=z.get(l)||function(t,e){const g={stylesheet:m(e),rules:{}};return z.set(t,g),g}(l,t);r[c]||(r[c]=!0,d.insertRule(`@keyframes ${c} ${a}`,d.cssRules.length));const h=t.style.animation||"";return t.style.animation=`${h?`${h}, `:""}${c} ${i}ms linear ${n}ms 1 both`,F+=1,c}function H(t,e){const g=(t.style.animation||"").split(", "),i=g.filter(e?t=>t.indexOf(e)<0:t=>-1===t.indexOf("__svelte")),n=g.length-i.length;n&&(t.style.animation=i.join(", "),F-=n,F||l((()=>{F||(z.forEach((t=>{const{ownerNode:e}=t.stylesheet;e&&y(e)})),z.clear())})))}function J(t){x=t}function K(){if(!x)throw new Error("Function called outside component initialization");return x}function T(t){K().$$.on_mount.push(t)}const E=[],U=[],M=[],D=[],$=Promise.resolve();let Q=!1;function L(t){M.push(t)}const O=new Set;let j,P=0;function _(){if(0!==P)return;const t=x;do{try{for(;P<E.length;){const t=E[P];P++,J(t),q(t.$$)}}catch(t){throw E.length=0,P=0,t}for(J(null),E.length=0,P=0;U.length;)U.pop()();for(let t=0;t<M.length;t+=1){const e=M[t];O.has(e)||(O.add(e),e())}M.length=0}while(E.length);for(;D.length;)D.pop()();Q=!1,O.clear(),J(t)}function q(t){if(null!==t.fragment){t.update(),I(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(L)}}function tt(){return j||(j=Promise.resolve(),j.then((()=>{j=null}))),j}function et(t,e,g){t.dispatchEvent(function(t,e,{bubbles:g=!1,cancelable:i=!1}={}){const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,g,i,e),n}(`${e?"intro":"outro"}${g}`))}const gt=new Set;let it;function nt(t,e){t&&t.i&&(gt.delete(t),t.i(e))}function It(t,e,g,i){if(t&&t.o){if(gt.has(t))return;gt.add(t),it.c.push((()=>{gt.delete(t),i&&(g&&t.d(1),i())})),t.o(e)}else i&&i()}const Ct={duration:0},ot="undefined"!=typeof window?window:"undefined"!=typeof globalThis?globalThis:g.g;function st(t){t&&t.c()}function At(t,e,g,n){const{fragment:o,after_update:s}=t.$$;o&&o.m(e,g),n||L((()=>{const e=t.$$.on_mount.map(i).filter(C);t.$$.on_destroy?t.$$.on_destroy.push(...e):I(e),t.$$.on_mount=[]})),s.forEach(L)}function at(t,e){const g=t.$$;null!==g.fragment&&(I(g.on_destroy),g.fragment&&g.fragment.d(e),g.on_destroy=g.fragment=null,g.ctx=[])}function ct(e,g,i,C,o,s,A,a=[-1]){const c=x;J(e);const l=e.$$={fragment:null,ctx:[],props:s,update:t,not_equal:o,bound:n(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(g.context||(c?c.$$.context:[])),callbacks:n(),dirty:a,skip_bound:!1,root:g.target||c.$$.root};A&&A(l.root);let d=!1;if(l.ctx=i?i(e,g.props||{},((t,g,...i)=>{const n=i.length?i[0]:g;return l.ctx&&o(l.ctx[t],l.ctx[t]=n)&&(!l.skip_bound&&l.bound[t]&&l.bound[t](n),d&&function(t,e){-1===t.$$.dirty[0]&&(E.push(t),Q||(Q=!0,$.then(_)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}(e,t)),g})):[],l.update(),d=!0,I(l.before_update),l.fragment=!!C&&C(l.ctx),g.target){if(g.hydrate){const t=function(t){return Array.from(t.childNodes)}(g.target);l.fragment&&l.fragment.l(t),t.forEach(y)}else l.fragment&&l.fragment.c();g.intro&&nt(e.$$.fragment),At(e,g.target,g.anchor,g.customElement),_()}J(c)}let lt;"function"==typeof HTMLElement&&(lt=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const{on_mount:t}=this.$$;this.$$.on_disconnect=t.map(i).filter(C);for(const t in this.$$.slotted)this.appendChild(this.$$.slotted[t])}attributeChangedCallback(t,e,g){this[t]=g}disconnectedCallback(){I(this.$$.on_disconnect)}$destroy(){at(this,1),this.$destroy=t}$on(e,g){if(!C(g))return t;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(g),()=>{const t=i.indexOf(g);-1!==t&&i.splice(t,1)}}$set(t){this.$$set&&!A(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}});class dt{$destroy(){at(this,1),this.$destroy=t}$on(e,g){if(!C(g))return t;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(g),()=>{const t=i.indexOf(g);-1!==t&&i.splice(t,1)}}$set(t){this.$$set&&!A(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}function rt(t){b(t,"svelte-1mwhwtl",".Frame.svelte-1mwhwtl{position:absolute;width:100%;height:100%;top:50%;left:50%;transform-origin:50% 50%;transform:translate(-50%, -50%) rotate(var(--fx-rotation));transition:width 0.1s, height 0.1s;pointer-events:none;user-select:none}")}function ht(e){let g,i,n,I,C,o,s;return{c(){g=W("svg"),i=W("defs"),n=W("linearGradient"),I=W("stop"),C=W("stop"),o=W("circle"),s=W("circle"),B(I,"stop-color","var(--gradient-stop1)"),B(I,"offset","0%"),B(C,"stop-color","var(--gradient-stop2)"),B(C,"offset","100%"),B(n,"x1","50%"),B(n,"y1","0%"),B(n,"x2","50%"),B(n,"y2","100%"),B(n,"id","a"),B(o,"cx","46"),B(o,"cy","46"),B(o,"r",e[0]),B(o,"stroke","none"),B(o,"fill","var(--frame-background)"),B(s,"cx","46"),B(s,"cy","46"),B(s,"r",e[0]),B(s,"stroke","url(#a)"),B(s,"stroke-width","var(--frame-stroke-width)"),B(s,"fill","none"),B(g,"class","Frame svelte-1mwhwtl"),B(g,"viewBox","0 0 92 92"),B(g,"xmlns","http://www.w3.org/2000/svg")},m(t,e){G(t,g,e),u(g,i),u(i,n),u(n,I),u(n,C),u(g,o),u(g,s)},p(t,[e]){1&e&&B(o,"r",t[0]),1&e&&B(s,"r",t[0])},i:t,o:t,d(t){t&&y(g)}}}function ut(t,e,g){let{frameRadius:i=46}=e;return t.$$set=t=>{"frameRadius"in t&&g(0,i=t.frameRadius)},[i]}class bt extends dt{constructor(t){super(),ct(this,t,ut,ht,o,{frameRadius:0},rt)}}const pt=new Error("Current device does not support microphone API"),mt=new Error("AppId changed without project login");class Zt extends Error{constructor(t,e,g,...i){super(...i),this.name=`WebsocketError code ${e}`,this.message=t,this.code=e,this.wasClean=g}}const Gt=16e3;class yt{constructor(t,e){this.isFinalized=!1,this.words=[],this.entities=new Map,this.intent={intent:"",isFinal:!1},this.contextId=t,this.id=e}toSegment(){let t=0;const e=new Array(this.entities.size);return this.entities.forEach((g=>{e[t]=g,t++})),{id:this.id,contextId:this.contextId,isFinal:this.isFinalized,words:this.words,entities:e,intent:this.intent}}toString(){const t=this.toSegment(),e=t.words.filter((t=>t.value)),g=Object.assign(Object.assign({},t),{words:e});return JSON.stringify(g,null,2)}updateTranscript(t){return t.forEach((t=>{this.isFinalized&&!t.isFinal||(this.words[t.index]=t)})),this}updateEntities(t){return t.forEach((t=>{this.isFinalized&&!t.isFinal||this.entities.set(this.entityMapKey(t),t)})),this}updateIntent(t){return this.isFinalized&&!t.isFinal||(this.intent=t),this}finalize(){return this.entities.forEach(((t,e)=>{t.isFinal||this.entities.delete(e)})),this.words=this.words.filter((t=>t.isFinal)),this.intent.isFinal||(this.intent.intent="",this.intent.isFinal=!0),this.isFinalized=!0,this}entityMapKey(t){return`${t.startPosition.toString()}:${t.endPosition.toString()}`}}function vt(t,e,g,i){return new(g||(g=Promise))((function(n,I){function C(t){try{s(i.next(t))}catch(t){I(t)}}function o(t){try{s(i.throw(t))}catch(t){I(t)}}function s(t){var e;t.done?n(t.value):(e=t.value,e instanceof g?e:new g((function(t){t(e)}))).then(C,o)}s((i=i.apply(t,e||[])).next())}))}const Wt=new Error("Microphone consent is not given");var wt,Vt,Rt,ft;!function(t){t.NoAudioConsent="NoAudioConsent",t.NoBrowserSupport="NoBrowserSupport",t.Stopped="Stopped",t.Starting="Starting",t.Started="Started"}(wt||(wt={}));class Bt{constructor(){this.muted=!1,this.initialized=!1,this.state=wt.Stopped,this.debug=!1,this.stateChangeCbs=[];try{const t=window.navigator.mediaDevices.getSupportedConstraints();this.nativeResamplingSupported=!0===t.sampleRate,this.autoGainControlSupported=!0===t.autoGainControl}catch(t){this.nativeResamplingSupported=!1,this.autoGainControlSupported=!1}}onStateChange(t){this.stateChangeCbs.push(t)}initialize(){var t;return vt(this,void 0,void 0,(function*(){if(this.initialized)return;if(void 0===(null===(t=window.navigator)||void 0===t?void 0:t.mediaDevices))throw this.setState(wt.NoBrowserSupport),pt;const e={video:!1};this.nativeResamplingSupported||this.autoGainControlSupported?e.audio={sampleRate:Gt,autoGainControl:this.autoGainControlSupported}:e.audio=!0;try{this.setState(wt.Starting),this.mediaStream=yield window.navigator.mediaDevices.getUserMedia(e)}catch(t){throw this.setState(wt.NoAudioConsent),console.error(t),Wt}this.initialized=!0,this.muted=!0,this.setState(wt.Started)}))}setState(t){this.state!==t&&(this.debug&&console.log("[BrowserMicrophone]",this.state,"->",t),this.state=t,this.stateChangeCbs.forEach((e=>e(t))))}close(){return vt(this,void 0,void 0,(function*(){this.initialized&&(this.muted=!0,this.mediaStream.getTracks().forEach((t=>t.stop())),this.mediaStream=void 0,this.initialized=!1,this.setState(wt.Stopped))}))}isRecording(){return!this.muted}}!function(t){t.Started="started",t.Stopped="stopped",t.SegmentEnd="segment_end",t.Transcript="transcript",t.Entity="entity",t.Intent="intent",t.TentativeTranscript="tentative_transcript",t.TentativeEntities="tentative_entities",t.TentativeIntent="tentative_intent"}(Vt||(Vt={})),function(t){t.Opened="WEBSOCKET_OPEN",t.Closed="WEBSOCKET_CLOSED",t.AudioProcessorReady="SOURCE_SAMPLE_RATE_SET_SUCCESS",t.VadSignalHigh="VadSignalHigh",t.VadSignalLow="VadSignalLow",t.RequestContextStart="RequestContextStart"}(Rt||(Rt={})),function(t){t.connect="connect",t.initAudioProcessor="initAudioProcessor",t.adjustAudioProcessor="adjustAudioProcessor",t.SET_SHARED_ARRAY_BUFFERS="SET_SHARED_ARRAY_BUFFERS",t.CLOSE="CLOSE",t.START_CONTEXT="START_CONTEXT",t.SWITCH_CONTEXT="SWITCH_CONTEXT",t.STOP_CONTEXT="STOP_CONTEXT",t.AUDIO="AUDIO",t.startStream="startStream",t.stopStream="stopStream",t.setContextOptions="setContextOptions"}(ft||(ft={}));const Xt={connect:!0,apiUrl:"https://api.speechly.com",sampleRate:Gt,debug:!1,logSegments:!1,frameMillis:30,historyFrames:5},St={enabled:!1,controlListening:!0,signalToNoiseDb:3,noiseGateDb:-24,noiseLearnHalftimeMillis:400,signalSearchFrames:5,signalActivation:.7,signalRelease:.2,signalSustainMillis:3e3},Nt={preserveSegments:!1,sampleRate:Gt,immediate:!1,autoStarted:!1};var Yt;!function(t){t[t.Failed=0]="Failed",t[t.Disconnected=1]="Disconnected",t[t.Connected=2]="Connected",t[t.Active=3]="Active"}(Yt||(Yt={}));class zt extends Array{addEventListener(t){this.push(t)}removeEventListener(t){const e=this.findIndex((e=>e===t));e>=0&&this.splice(e,1)}}class xt{constructor(){this.stateChangeCbs=new zt,this.transcriptCbs=new zt,this.entityCbs=new zt,this.intentCbs=new zt,this.segmentChangeCbs=new zt,this.tentativeTranscriptCbs=new zt,this.tentativeEntityCbs=new zt,this.tentativeIntentCbs=new zt,this.contextStartedCbs=new zt,this.contextStoppedCbs=new zt,this.onVadStateChange=new zt}}const Ft=new Error("BrowserClient already started"),kt=new Error("BrowserClient already stopped");function Ht(t){var e;return null!==(e=Jt.get(t))&&void 0!==e?e:"unknown"}const Jt=new Map([[Yt.Failed,"Failed"],[Yt.Disconnected,"Disconnected"],[Yt.Connected,"Connected"],[Yt.Active,"Active"]]);var Kt,Tt=new Uint8Array(16);function Et(){if(!Kt&&!(Kt="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Kt(Tt)}for(var Ut=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,Mt=[],Dt=0;Dt<256;++Dt)Mt.push((Dt+256).toString(16).substr(1));function $t(t,e,g){var i=(t=t||{}).random||(t.rng||Et)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,e){g=g||0;for(var n=0;n<16;++n)e[g+n]=i[n];return e}return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,g=(Mt[t[e+0]]+Mt[t[e+1]]+Mt[t[e+2]]+Mt[t[e+3]]+"-"+Mt[t[e+4]]+Mt[t[e+5]]+"-"+Mt[t[e+6]]+Mt[t[e+7]]+"-"+Mt[t[e+8]]+Mt[t[e+9]]+"-"+Mt[t[e+10]]+Mt[t[e+11]]+Mt[t[e+12]]+Mt[t[e+13]]+Mt[t[e+14]]+Mt[t[e+15]]).toLowerCase();if(!function(t){return"string"==typeof t&&Ut.test(t)}(g))throw TypeError("Stringified UUID is invalid");return g}(i)}var Qt,Lt,Ot="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==g.g?g.g:"undefined"!=typeof self?self:{},jt={exports:{}};Qt=jt,Lt=jt.exports,function(t){var e=Lt,g=Qt&&Qt.exports==e&&Qt,i="object"==typeof Ot&&Ot;i.global!==i&&i.window!==i||(t=i);var n=function(t){this.message=t};(n.prototype=new Error).name="InvalidCharacterError";var I=function(t){throw new n(t)},C="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=/[\t\n\f\r ]/g,s={encode:function(t){t=String(t),/[^\0-\xFF]/.test(t)&&I("The string to be encoded contains characters outside of the Latin1 range.");for(var e,g,i,n,o=t.length%3,s="",A=-1,a=t.length-o;++A<a;)e=t.charCodeAt(A)<<16,g=t.charCodeAt(++A)<<8,i=t.charCodeAt(++A),s+=C.charAt((n=e+g+i)>>18&63)+C.charAt(n>>12&63)+C.charAt(n>>6&63)+C.charAt(63&n);return 2==o?(e=t.charCodeAt(A)<<8,g=t.charCodeAt(++A),s+=C.charAt((n=e+g)>>10)+C.charAt(n>>4&63)+C.charAt(n<<2&63)+"="):1==o&&(n=t.charCodeAt(A),s+=C.charAt(n>>2)+C.charAt(n<<4&63)+"=="),s},decode:function(t){var e=(t=String(t).replace(o,"")).length;e%4==0&&(e=(t=t.replace(/==?$/,"")).length),(e%4==1||/[^+a-zA-Z0-9/]/.test(t))&&I("Invalid character: the string to be decoded is not correctly encoded.");for(var g,i,n=0,s="",A=-1;++A<e;)i=C.indexOf(t.charAt(A)),g=n%4?64*g+i:i,n++%4&&(s+=String.fromCharCode(255&g>>(-2*n&6)));return s},version:"0.1.0"};if(e&&!e.nodeType)if(g)g.exports=s;else for(var A in s)s.hasOwnProperty(A)&&(e[A]=s[A]);else t.base64=s}(Ot);function Pt(t,e,g,i,n=Date.now){const I=function(t){const e=t.split(".")[1];let g;try{g=JSON.parse(jt.exports.decode(e))}catch(t){throw new Error("Error decoding Speechly token!")}return{appId:g.appId,projectId:g.projectId,deviceId:g.deviceId,configId:g.configId,scopes:g.scope.split(" "),issuer:g.iss,audience:g.aud,expiresAtMs:1e3*g.exp}}(t);return!(I.expiresAtMs-n()<36e5)&&I.appId===g&&I.projectId===e&&I.deviceId===i}var _t=function(t,e,g){var i;return function(t){return i=i||function(t,e,g){var i=void 0===e?null:e,n=function(t,e){var g=atob(t);if(e){for(var i=new Uint8Array(g.length),n=0,I=g.length;n<I;++n)i[n]=g.charCodeAt(n);return String.fromCharCode.apply(null,new Uint16Array(i.buffer))}return g}(t,void 0!==g&&g),I=n.indexOf("\n",10)+1,C=n.substring(I)+(i?"//# sourceMappingURL="+i:""),o=new Blob([C],{type:"application/javascript"});return URL.createObjectURL(o)}("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwp2YXIgd29ya2VyX2NvZGUgPSAoZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICAvKioKICAgICAqIEBpbnRlcm5hbAogICAgICovCiAgICBjbGFzcyBBdWRpb1Rvb2xzIHsKICAgICAgICBzdGF0aWMgZG93bnNhbXBsZShzcmMsIGRlc3QsIHNvdXJjZUluZGV4ID0gMCwgc291cmNlTGVuZ3RoID0gLTEsIGRlc3RJbmRleCA9IDAsIGRlc3RMZW5ndGggPSAtMSkgewogICAgICAgICAgICBpZiAoc291cmNlTGVuZ3RoIDwgMCkKICAgICAgICAgICAgICAgIHNvdXJjZUxlbmd0aCA9IHNyYy5sZW5ndGggLSBzb3VyY2VJbmRleDsKICAgICAgICAgICAgaWYgKGRlc3RMZW5ndGggPCAwKQogICAgICAgICAgICAgICAgZGVzdExlbmd0aCA9IGRlc3QubGVuZ3RoIC0gZGVzdEluZGV4OwogICAgICAgICAgICBpZiAoZGVzdExlbmd0aCA+IHNvdXJjZUxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW4ndCBkb3duc2FtcGxlOiBzb3VyY2UgYXJyYXkgbGVuZ3RoICgke3NvdXJjZUxlbmd0aH0pIGlzIHNob3J0ZXIgdGhhbiBkZXN0aW5hdGlvbiAoJHtkZXN0TGVuZ3RofSlgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVzdExlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW4ndCBkb3duc2FtcGxlOiBzb3VyY2UgYXJyYXkgbGVuZ3RoICgke3NvdXJjZUxlbmd0aH0pIGNhbid0IGJlIGRvd25zYW1wbGVkIHRvIHplcm8tbGVuZ3RoIGRlc3RpbmF0aW9uLmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzb3VyY2VMZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2FuJ3QgZG93bnNhbXBsZTogc291cmNlIHJhbmdlIGNhbid0IGJlIHplcm8gbGVuZ3RoLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzb3VyY2VMZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIGRlc3RbMF0gPSBzcmNbMF07CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGRlc3RJbmRleEZyYWN0aW9uID0gMC4wOwogICAgICAgICAgICBjb25zdCBkZXN0U3RlcCA9IChkZXN0TGVuZ3RoIC0gMSkgLyAoc291cmNlTGVuZ3RoIC0gMSk7CiAgICAgICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgICAgICBsZXQgdG90YWxXZWlnaHQgPSAwOwogICAgICAgICAgICBjb25zdCBzb3VyY2VFbmRJbmRleCA9IHNvdXJjZUluZGV4ICsgc291cmNlTGVuZ3RoOwogICAgICAgICAgICBmb3IgKDsgc291cmNlSW5kZXggPCBzb3VyY2VFbmRJbmRleDsgc291cmNlSW5kZXgrKykgewogICAgICAgICAgICAgICAgY29uc3Qgd2VpZ2h0ID0gMC41IC0gTWF0aC5hYnMoZGVzdEluZGV4RnJhY3Rpb24pOwogICAgICAgICAgICAgICAgc3VtICs9IHNyY1tzb3VyY2VJbmRleF0gKiB3ZWlnaHQ7CiAgICAgICAgICAgICAgICB0b3RhbFdlaWdodCArPSB3ZWlnaHQ7CiAgICAgICAgICAgICAgICBkZXN0SW5kZXhGcmFjdGlvbiArPSBkZXN0U3RlcDsKICAgICAgICAgICAgICAgIGlmIChkZXN0SW5kZXhGcmFjdGlvbiA+PSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0SW5kZXhGcmFjdGlvbiAtPSAxOwogICAgICAgICAgICAgICAgICAgIGRlc3RbZGVzdEluZGV4KytdID0gc3VtIC8gdG90YWxXZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgc3VtID0gMDsKICAgICAgICAgICAgICAgICAgICB0b3RhbFdlaWdodCA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUHV0IGxhc3QgdmFsdWUgaW4gcGxhY2UKICAgICAgICAgICAgaWYgKHRvdGFsV2VpZ2h0ID4gMCkgewogICAgICAgICAgICAgICAgZGVzdFtkZXN0SW5kZXgrK10gPSBzdW0gLyB0b3RhbFdlaWdodDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGF0aWMgZ2V0RW5lcmd5KHNhbXBsZXMsIHN0YXJ0ID0gMCwgbGVuZ3RoID0gLTEpIHsKICAgICAgICAgICAgaWYgKGxlbmd0aCA8IDApCiAgICAgICAgICAgICAgICBsZW5ndGggPSBzYW1wbGVzLmxlbmd0aCAtIHN0YXJ0OwogICAgICAgICAgICBpZiAobGVuZ3RoIDw9IDApCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgY29uc3QgZW5kSW5kZXggPSBzdGFydCArIGxlbmd0aDsKICAgICAgICAgICAgbGV0IHN1bUVuZXJneVNxdWFyZWQgPSAwLjA7CiAgICAgICAgICAgIGZvciAoOyBzdGFydCA8IGVuZEluZGV4OyBzdGFydCsrKSB7CiAgICAgICAgICAgICAgICBzdW1FbmVyZ3lTcXVhcmVkICs9IHNhbXBsZXNbc3RhcnRdICogc2FtcGxlc1tzdGFydF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIE1hdGguc3FydChzdW1FbmVyZ3lTcXVhcmVkIC8gbGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGdldEF1ZGlvUGVhayhzYW1wbGVzLCBzdGFydCA9IDAsIGxlbmd0aCA9IC0xKSB7CiAgICAgICAgICAgIGlmIChsZW5ndGggPCAwKQogICAgICAgICAgICAgICAgbGVuZ3RoID0gc2FtcGxlcy5sZW5ndGggLSBzdGFydDsKICAgICAgICAgICAgaWYgKGxlbmd0aCA8PSAwKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IGVuZEluZGV4ID0gc3RhcnQgKyBsZW5ndGg7CiAgICAgICAgICAgIGxldCBwZWFrID0gMDsKICAgICAgICAgICAgZm9yICg7IHN0YXJ0IDwgZW5kSW5kZXg7IHN0YXJ0KyspIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVzW3N0YXJ0XSA+IHBlYWspIHsKICAgICAgICAgICAgICAgICAgICBwZWFrID0gc2FtcGxlc1tzdGFydF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBlYWs7CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBjb252ZXJ0SW50MTZUb0Zsb2F0KHNyYywgZGVzdCwgc3JjU3RhcnRTYW1wbGUgPSAwLCBsZW5ndGhTYW1wbGVzID0gLTEsIGRzdEluZGV4ID0gMCkgewogICAgICAgICAgICBpZiAobGVuZ3RoU2FtcGxlcyA8IDApCiAgICAgICAgICAgICAgICBsZW5ndGhTYW1wbGVzID0gc3JjLmxlbmd0aCAvIDIgLSBzcmNTdGFydFNhbXBsZTsKICAgICAgICAgICAgY29uc3QgbWF4TGVuID0gTWF0aC5taW4oKHNyYy5sZW5ndGggLyAyKSAtIHNyY1N0YXJ0U2FtcGxlLCBkZXN0Lmxlbmd0aCAtIGRzdEluZGV4KTsKICAgICAgICAgICAgbGVuZ3RoU2FtcGxlcyA9IE1hdGgubWluKGxlbmd0aFNhbXBsZXMsIG1heExlbik7CiAgICAgICAgICAgIGlmIChsZW5ndGhTYW1wbGVzIDw9IDApCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHNyY1N0YXJ0U2FtcGxlICogMjsKICAgICAgICAgICAgY29uc3QgZW5kQnl0ZSA9IGJ5dGVJbmRleCArIGxlbmd0aFNhbXBsZXMgKiAyOwogICAgICAgICAgICB3aGlsZSAoYnl0ZUluZGV4IDwgZW5kQnl0ZSkgewogICAgICAgICAgICAgICAgZGVzdFtkc3RJbmRleCsrXSA9ICgoc3JjW2J5dGVJbmRleCsrXSArIChzcmNbYnl0ZUluZGV4KytdIDw8IDgpKSkgLyAweDdmZmY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlbmd0aFNhbXBsZXM7CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBjb252ZXJ0RmxvYXRUb0ludDE2KHNyYywgZGVzdCwgc291cmNlSW5kZXggPSAwLCBzb3VyY2VMZW5ndGggPSAtMSwgZHN0SW5kZXggPSAwKSB7CiAgICAgICAgICAgIGlmIChzb3VyY2VMZW5ndGggPCAwKQogICAgICAgICAgICAgICAgc291cmNlTGVuZ3RoID0gc3JjLmxlbmd0aCAtIHNvdXJjZUluZGV4OwogICAgICAgICAgICBjb25zdCBlbmRJbmRleCA9IHNvdXJjZUluZGV4ICsgc291cmNlTGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoc291cmNlSW5kZXggPCBlbmRJbmRleCkgewogICAgICAgICAgICAgICAgZGVzdFtkc3RJbmRleCsrXSA9IH5+KHNyY1tzb3VyY2VJbmRleCsrXSAqIDB4N2ZmZik7IC8vIFF1aWNrIHRydW5jYXRlLCBubyByb3VuZGluZwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBlbmVyZ3lUb0RiKGVuZXJneSkgewogICAgICAgICAgICByZXR1cm4gKDEwLjAgKiBNYXRoLmxvZyhlbmVyZ3kpIC8gQXVkaW9Ub29scy5MT0dfMl9QTFVTX0xPR181KTsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGRiVG9FbmVyZ3koZGIpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgucG93KDEwLjAsIGRiIC8gMTAuMCk7CiAgICAgICAgfQogICAgfQogICAgQXVkaW9Ub29scy5MT0dfMl9QTFVTX0xPR181ID0gTWF0aC5sb2coMikgKyBNYXRoLmxvZyg1KTsKCiAgICAvKioKICAgICAqIEBpbnRlcm5hbAogICAgICovCiAgICBjbGFzcyBBdWRpb1Byb2Nlc3NvciB7CiAgICAgICAgY29uc3RydWN0b3IoaW5wdXRTYW1wbGVSYXRlLCBvdXRwdXRTYW1wbGVSYXRlLCBmcmFtZU1pbGxpcywgaGlzdG9yeUZyYW1lcykgewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogU2VuZGluZyBzdGF0ZS4gSWYgdHJ1ZSwgQXVkaW9Qcm9jZXNzb3IgaXMgY3VycmVudGx5IHNlbmRpbmcgYXVkaW8gdmlhIG9uU2VuZEF1ZGlvIGNhbGxiYWNrCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB0aGlzLmlzU2VuZGluZyA9IGZhbHNlOwogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQ3VycmVudCBjb3VudCBvZiBkb3duc2FtcGxlZCBhbmQgY29udGludW91c2x5IHByb2Nlc3NlZCBzYW1wbGVzICh0aHJ1IFByb2Nlc3NBdWRpbykgZnJvbSBzdGFydCBvZiBzdHJlYW0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuc3RyZWFtU2FtcGxlUG9zID0gMDsKICAgICAgICAgICAgdGhpcy5zYW1wbGVzU2VudCA9IDA7CiAgICAgICAgICAgIHRoaXMudXR0ZXJhbmNlU2VyaWFsID0gLTE7CiAgICAgICAgICAgIHRoaXMub25TZW5kQXVkaW8gPSAoc2FtcGxlcywgc3RhcnRJbmRleCwgbGVuZ3RoKSA9PiB7IH07CiAgICAgICAgICAgIHRoaXMub25WYWRTdGF0ZUNoYW5nZSA9IChpc1NpZ25hbERldGVjdGVkKSA9PiB7IH07CiAgICAgICAgICAgIHRoaXMuaW5wdXRTYW1wbGVSYXRlID0gMTYwMDA7CiAgICAgICAgICAgIHRoaXMuaW50ZXJuYWxTYW1wbGVSYXRlID0gMTYwMDA7CiAgICAgICAgICAgIHRoaXMuaGlzdG9yeUZyYW1lcyA9IDU7CiAgICAgICAgICAgIHRoaXMuZnJhbWVNaWxsaXMgPSAzMDsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWVOdW1iZXIgPSAwOwogICAgICAgICAgICB0aGlzLmZyYW1lU2FtcGxlUG9zID0gMDsKICAgICAgICAgICAgdGhpcy5zdHJlYW1GcmFtZVBvcyA9IDA7CiAgICAgICAgICAgIHRoaXMud2FzU2lnbmFsRGV0ZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5pbnB1dFNhbXBsZVJhdGUgPSBpbnB1dFNhbXBsZVJhdGU7CiAgICAgICAgICAgIHRoaXMuaW50ZXJuYWxTYW1wbGVSYXRlID0gb3V0cHV0U2FtcGxlUmF0ZTsKICAgICAgICAgICAgdGhpcy5mcmFtZU1pbGxpcyA9IGZyYW1lTWlsbGlzOwogICAgICAgICAgICB0aGlzLmhpc3RvcnlGcmFtZXMgPSBoaXN0b3J5RnJhbWVzOwogICAgICAgICAgICB0aGlzLmZyYW1lU2FtcGxlcyA9IH5+KHRoaXMuaW50ZXJuYWxTYW1wbGVSYXRlICogdGhpcy5mcmFtZU1pbGxpcyAvIDEwMDApOwogICAgICAgICAgICB0aGlzLnNhbXBsZVJpbmdCdWZmZXIgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuZnJhbWVTYW1wbGVzICogdGhpcy5oaXN0b3J5RnJhbWVzKTsKICAgICAgICB9CiAgICAgICAgLyoqCiAgICAgICAgICogUHJvY2VzcyBzcGVlY2ggYXVkaW8gc2FtcGxlcyBmcm9tIGEgbWljcm9waG9uZSBvciBvdGhlciBhdWRpbyBzb3VyY2UuCiAgICAgICAgICoKICAgICAgICAgKiBZb3UgY2FuIGNvbnRyb2wgd2hlbiB0byBzdGFydCBhbmQgc3RvcCBwcm9jZXNzIHNwZWVjaCBlaXRoZXIgbWFudWFsbHkgd2l0aCA8c2VlIGNyZWY9IlN0YXJ0Q29udGV4dCIvPiBhbmQgPHNlZSBjcmVmPSJTdG9wQ29udGV4dCIvPiBvcgogICAgICAgICAqIGF1dG9tYXRpY2FsbHkgYnkgcHJvdmlkaW5nIGEgdm9pY2UgYWN0aXZpdHkgZGV0ZWN0aW9uIChWQUQpIGZpZWxkIHRvIDxzZWUgY3JlZj0iU3BlZWNobHlDbGllbnQiLz4uCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgYXVkaW8gaXMgaGFuZGxlZCBhcyBmb2xsb3dzOgogICAgICAgICAqIC0gRG93bnNhbXBsZSB0byAxNmtIeiBpZiBuZWVkZWQKICAgICAgICAgKiAtIEFkZCB0byBoaXN0b3J5IHJpbmdidWZmZXIKICAgICAgICAgKiAtIENhbGN1bGF0ZSBlbmVyZ3kgKFZBRCkKICAgICAgICAgKiAtIEF1dG9tYXRpYyBTdGFydC9TdG9wQ29udGV4dCAoVkFEKQogICAgICAgICAqIC0gU2VuZCB1dHRlcmFuY2UgYXVkaW8gdG8gU3BlZWNobHkgU0xVIGRlY29kZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBmbG9hdHMgLSBBcnJheSBvZiBmbG9hdCBjb250YWluaW5nIHNhbXBsZXMgdG8gZmVlZCB0byB0aGUgYXVkaW8gcGlwZWxpbmUuIEVhY2ggc2FtcGxlIG5lZWRzIHRvIGJlIGluIHJhbmdlIC0xZi4uMWYuCiAgICAgICAgICogQHBhcmFtIHN0YXJ0IC0gU3RhcnQgaW5kZXggb2YgYXVkaW8gdG8gcHJvY2VzcyBpbiBzYW1wbGVzIChkZWZhdWx0OiBgMGApLgogICAgICAgICAqIEBwYXJhbSBsZW5ndGggLSBMZW5ndGggb2YgYXVkaW8gdG8gcHJvY2VzcyBpbiBzYW1wbGVzIG9yIGAtMWAgdG8gcHJvY2VzcyB0aGUgd2hvbGUgYXJyYXkgKGRlZmF1bHQ6IGAtMWApLgogICAgICAgICAqIEBwYXJhbSBlb3NfYXRfZW5kIC0gU3RvcFN0cmVhbSBpbnRlcm5hbGx5IHVzZXMgdGhpcyB0byBmb3JjZSBwcm9jZXNzaW5nIG9mIGxhc3Qgc3ViZnJhbWUgYXQgZW5kIG9mIGF1ZGlvIHN0cmVhbSAoZGVmYXVsdDogYGZhbHNlYCkuCiAgICAgICAgICogQHJldHVybnMKICAgICAgICAgKi8KICAgICAgICBwcm9jZXNzQXVkaW8oZmxvYXRzLCBzdGFydCA9IDAsIGxlbmd0aCA9IC0xLCBlb3NfYXRfZW5kID0gZmFsc2UpIHsKICAgICAgICAgICAgaWYgKGxlbmd0aCA8IDApCiAgICAgICAgICAgICAgICBsZW5ndGggPSBmbG9hdHMubGVuZ3RoOwogICAgICAgICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBpZiAoZW9zX2F0X2VuZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0VvcygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBpID0gc3RhcnQ7CiAgICAgICAgICAgIGNvbnN0IGVuZEluZGV4ID0gc3RhcnQgKyBsZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpIDwgZW5kSW5kZXgpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGZyYW1lQmFzZSA9IHRoaXMuY3VycmVudEZyYW1lTnVtYmVyICogdGhpcy5mcmFtZVNhbXBsZXM7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnB1dFNhbXBsZVJhdGUgPT09IHRoaXMuaW50ZXJuYWxTYW1wbGVSYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29weSBpbnB1dCBzYW1wbGVzIHRvIGZpbGwgY3VycmVudCByaW5nYnVmZmVyIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2FtcGxlc1RvRmlsbEZyYW1lID0gTWF0aC5taW4oZW5kSW5kZXggLSBpLCB0aGlzLmZyYW1lU2FtcGxlcyAtIHRoaXMuZnJhbWVTYW1wbGVQb3MpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZyYW1lRW5kSW5kZXggPSB0aGlzLmZyYW1lU2FtcGxlUG9zICsgc2FtcGxlc1RvRmlsbEZyYW1lOwogICAgICAgICAgICAgICAgICAgIHdoaWxlICh0aGlzLmZyYW1lU2FtcGxlUG9zIDwgZnJhbWVFbmRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhbXBsZVJpbmdCdWZmZXJbZnJhbWVCYXNlICsgdGhpcy5mcmFtZVNhbXBsZVBvcysrXSA9IGZsb2F0c1tpKytdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIERvd25zYW1wbGUgaW5wdXQgc2FtcGxlcyB0byBmaWxsIGN1cnJlbnQgcmluZ2J1ZmZlciBmcmFtZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gMS4wICogdGhpcy5pbnB1dFNhbXBsZVJhdGUgLyB0aGlzLmludGVybmFsU2FtcGxlUmF0ZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dFNhbXBsZXNUb0ZpbGxGcmFtZSA9IE1hdGgubWluKGVuZEluZGV4IC0gaSwgTWF0aC5yb3VuZChyYXRpbyAqICh0aGlzLmZyYW1lU2FtcGxlcyAtIHRoaXMuZnJhbWVTYW1wbGVQb3MpKSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2FtcGxlc1RvRmlsbEZyYW1lID0gTWF0aC5taW4oTWF0aC5yb3VuZCgoZW5kSW5kZXggLSBpKSAvIHJhdGlvKSwgdGhpcy5mcmFtZVNhbXBsZXMgLSB0aGlzLmZyYW1lU2FtcGxlUG9zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc2FtcGxlc1RvRmlsbEZyYW1lID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBBdWRpb1Rvb2xzLmRvd25zYW1wbGUoZmxvYXRzLCB0aGlzLnNhbXBsZVJpbmdCdWZmZXIsIGksIGlucHV0U2FtcGxlc1RvRmlsbEZyYW1lLCBmcmFtZUJhc2UgKyB0aGlzLmZyYW1lU2FtcGxlUG9zLCBzYW1wbGVzVG9GaWxsRnJhbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpICs9IGlucHV0U2FtcGxlc1RvRmlsbEZyYW1lOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZnJhbWVTYW1wbGVQb3MgKz0gc2FtcGxlc1RvRmlsbEZyYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgZW9zID0gaSA9PT0gZW5kSW5kZXggJiYgZW9zX2F0X2VuZDsKICAgICAgICAgICAgICAgIC8vIFByb2Nlc3MgZnJhbWUKICAgICAgICAgICAgICAgIGlmICh0aGlzLmZyYW1lU2FtcGxlUG9zID09PSB0aGlzLmZyYW1lU2FtcGxlcyB8fCBlb3MpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdWJGcmFtZVNhbXBsZXMgPSBlb3MgPyB0aGlzLmZyYW1lU2FtcGxlUG9zIDogdGhpcy5mcmFtZVNhbXBsZXM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzRnJhbWUodGhpcy5zYW1wbGVSaW5nQnVmZmVyLCBmcmFtZUJhc2UsIHN1YkZyYW1lU2FtcGxlcywgZW9zKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1NlbmRpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2FtcGxlc1NlbnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0YXJ0IG9mIHRoZSB1dHRlcmFuY2UgLSBzZW5kIGhpc3RvcnkgZnJhbWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzZW5kSGlzdG9yeSA9IE1hdGgubWluKHRoaXMuc3RyZWFtRnJhbWVQb3MsIHRoaXMuaGlzdG9yeUZyYW1lcyAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGhpc3RvcnlGcmFtZUluZGV4ID0gKHRoaXMuY3VycmVudEZyYW1lTnVtYmVyICsgdGhpcy5oaXN0b3J5RnJhbWVzIC0gc2VuZEhpc3RvcnkpICUgdGhpcy5oaXN0b3J5RnJhbWVzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGhpc3RvcnlGcmFtZUluZGV4ICE9PSB0aGlzLmN1cnJlbnRGcmFtZU51bWJlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25TZW5kQXVkaW8odGhpcy5zYW1wbGVSaW5nQnVmZmVyLCBoaXN0b3J5RnJhbWVJbmRleCAqIHRoaXMuZnJhbWVTYW1wbGVzLCB0aGlzLmZyYW1lU2FtcGxlcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYW1wbGVzU2VudCArPSB0aGlzLmZyYW1lU2FtcGxlczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5RnJhbWVJbmRleCA9IChoaXN0b3J5RnJhbWVJbmRleCArIDEpICUgdGhpcy5oaXN0b3J5RnJhbWVzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25TZW5kQXVkaW8odGhpcy5zYW1wbGVSaW5nQnVmZmVyLCBmcmFtZUJhc2UsIHN1YkZyYW1lU2FtcGxlcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2FtcGxlc1NlbnQgKz0gc3ViRnJhbWVTYW1wbGVzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZW9zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RyZWFtU2FtcGxlUG9zICs9IHN1YkZyYW1lU2FtcGxlczsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzRW9zKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZnJhbWVTYW1wbGVQb3MgPT09IHRoaXMuZnJhbWVTYW1wbGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZnJhbWVTYW1wbGVQb3MgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0cmVhbUZyYW1lUG9zICs9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RyZWFtU2FtcGxlUG9zICs9IHN1YkZyYW1lU2FtcGxlczsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWVOdW1iZXIgPSAodGhpcy5jdXJyZW50RnJhbWVOdW1iZXIgKyAxKSAlIHRoaXMuaGlzdG9yeUZyYW1lczsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy52YWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLndhc1NpZ25hbERldGVjdGVkID0gdGhpcy52YWQuaXNTaWduYWxEZXRlY3RlZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRTZW5kQXVkaW8oYWN0aXZlKSB7CiAgICAgICAgICAgIHRoaXMuaXNTZW5kaW5nID0gYWN0aXZlOwogICAgICAgICAgICBpZiAoYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNhbXBsZXNTZW50ID0gMDsKICAgICAgICAgICAgICAgIHRoaXMudXR0ZXJhbmNlU2VyaWFsKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzZXQoaW5wdXRTYW1wbGVSYXRlKSB7CiAgICAgICAgICAgIHZhciBfYTsKICAgICAgICAgICAgdGhpcy5pc1NlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdHJlYW1GcmFtZVBvcyA9IDA7CiAgICAgICAgICAgIHRoaXMuc3RyZWFtU2FtcGxlUG9zID0gMDsKICAgICAgICAgICAgdGhpcy5mcmFtZVNhbXBsZVBvcyA9IDA7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZyYW1lTnVtYmVyID0gMDsKICAgICAgICAgICAgdGhpcy51dHRlcmFuY2VTZXJpYWwgPSAtMTsKICAgICAgICAgICAgaWYgKGlucHV0U2FtcGxlUmF0ZSkKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRTYW1wbGVSYXRlID0gaW5wdXRTYW1wbGVSYXRlOwogICAgICAgICAgICB0aGlzLndhc1NpZ25hbERldGVjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIChfYSA9IHRoaXMudmFkKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVzZXRWQUQoKTsKICAgICAgICB9CiAgICAgICAgLyoqCiAgICAgICAgICogQHJldHVybnMgY3VycmVudCBwb3NpdGlvbiBpbiBzdHJlYW0gaW4gbWlsbGlzZWNvbmRzCiAgICAgICAgICovCiAgICAgICAgZ2V0U3RyZWFtUG9zaXRpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHRoaXMuc3RyZWFtU2FtcGxlUG9zIC8gdGhpcy5pbnRlcm5hbFNhbXBsZVJhdGUgKiAxMDAwKTsKICAgICAgICB9CiAgICAgICAgZW9zKCkgewogICAgICAgICAgICB0aGlzLnByb2Nlc3NBdWRpbyh0aGlzLnNhbXBsZVJpbmdCdWZmZXIsIDAsIHRoaXMuZnJhbWVTYW1wbGVQb3MsIHRydWUpOwogICAgICAgIH0KICAgICAgICBwcm9jZXNzRnJhbWUoZmxvYXRzLCBzdGFydCA9IDAsIGxlbmd0aCA9IC0xLCBlb3MgPSBmYWxzZSkgewogICAgICAgICAgICB2YXIgX2E7CiAgICAgICAgICAgIGlmICgoX2EgPSB0aGlzLnZhZCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnZhZE9wdGlvbnMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgdGhpcy52YWQucHJvY2Vzc0ZyYW1lKGZsb2F0cywgc3RhcnQsIGxlbmd0aCwgZW9zKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZhZC5pc1NpZ25hbERldGVjdGVkICE9PSB0aGlzLndhc1NpZ25hbERldGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vblZhZFN0YXRlQ2hhbmdlKHRoaXMudmFkLmlzU2lnbmFsRGV0ZWN0ZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHByb2Nlc3NFb3MoKSB7CiAgICAgICAgICAgIHZhciBfYTsKICAgICAgICAgICAgaWYgKHRoaXMuaXNTZW5kaW5nICYmICgoX2EgPSB0aGlzLnZhZCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnZhZE9wdGlvbnMuZW5hYmxlZCkpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBWQUQgc3RhdGUgY2hhbmdlIG9uIGVuZC1vZi1zdHJlYW0KICAgICAgICAgICAgICAgIHRoaXMudmFkLnJlc2V0VkFEKCk7CiAgICAgICAgICAgICAgICB0aGlzLm9uVmFkU3RhdGVDaGFuZ2UoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQWRhcHRpdmUgZW5lcmd5IHRocmVzaG9sZCB2b2ljZSBhY3Rpdml0eSBkZXRlY3Rpb24gKFZBRCkgaW1wbGVtZW50YXRpb24uCiAgICAgKiBJdCBjYW4gYmUgdXNlZCB0byBlbmFibGUgaGFuZHMtZnJlZSBvcGVyYXRpb24gb2YgdGhlIFNMVSBkZWNvZGVyLgogICAgICoKICAgICAqIFdoZW4gZW5vdWdoIGZyYW1lcyB3aXRoIGEgc2lnbmFsIHN0cm9uZ2VyIHRoYW4gU2lnbmFsVG9Ob2lzZURiIGhhdmUgYmVlbiBkZXRlY3RlZCwgSXNTaWduYWxEZXRlY3RlZCBnb2VzIHRydWUuIFdoZW4gZW5vdWdoIHNpbGVudCBmcmFtZXMgaGF2ZSBiZWVuIGRldGVjdGVkLCBJc1NpZ25hbERldGVjdGVkIGdvZXMgZmFsc2UgYWZ0ZXIgdGhlIHN1c3RhaW4gdGltZS4KICAgICAqIFVzZSBpdHMgcHVibGljIGZpZWxkcyB0byBjb25maWd1cmUgdGhlIHN0YXRpYyBub2lzZSBnYXRlIGxldmVsLCBzaWduYWwtdG8tbm9pc2UgbGV2ZWwsIGFjdGl2YXRpb24vZGVhY3RpdmF0aW9uIHRyZXNob2xkIChyYXRpbyBvZiBzaWduYWwgdG8gc2lsZW50IGZyYW1lcykgYW5kIHRoZSBzaWduYWwgc3VzdGFpbiB0aW1lLgogICAgICogVGhlIGJhY2tncm91bmQgbm9pc2UgbGV2ZWwgZ3JhZHVhbGx5IGFkYXB0cyB3aGVuIG5vIHNpZ25hbCBpcyBkZXRlY3RlZC4KICAgICAqCiAgICAgKiBJc1NpZ25hbERldGVjdGVkIGNhbiBiZSB1c2VkIHRvIGRyaXZlIFNwZWVjaGx5Q2xpZW50J3MgU3RhcnRDb250ZXh0IGFuZCBTdG9wQ29udGV4dCBhdXRvbWF0aWNhbGx5IGJ5IHNldHRpbmcgQ29udHJvbExpc3RlbmluZyB0cnVlLgogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIGNsYXNzIEVuZXJneVRyZXNob2xkVkFEIHsKICAgICAgICBjb25zdHJ1Y3RvcihmcmFtZU1pbGxpcywgdmFkT3B0aW9ucykgewogICAgICAgICAgICB0aGlzLmlzU2lnbmFsRGV0ZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaWduYWxEYiA9IC05MC4wOwogICAgICAgICAgICB0aGlzLm5vaXNlTGV2ZWxEYiA9IC05MC4wOwogICAgICAgICAgICB0aGlzLmZyYW1lTWlsbGlzID0gMzA7CiAgICAgICAgICAgIHRoaXMuZW5lcmd5ID0gMC4wOwogICAgICAgICAgICB0aGlzLmJhc2VsaW5lRW5lcmd5ID0gLTEuMDsKICAgICAgICAgICAgdGhpcy5sb3VkRnJhbWVCaXRzID0gMDsKICAgICAgICAgICAgdGhpcy52YWRTdXN0YWluTWlsbGlzTGVmdCA9IDA7CiAgICAgICAgICAgIHRoaXMuZnJhbWVNaWxsaXMgPSBmcmFtZU1pbGxpczsKICAgICAgICAgICAgdGhpcy52YWRPcHRpb25zID0gdmFkT3B0aW9uczsKICAgICAgICB9CiAgICAgICAgYWRqdXN0VmFkT3B0aW9ucyh2YWRPcHRpb25zKSB7CiAgICAgICAgICAgIHRoaXMudmFkT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgdGhpcy52YWRPcHRpb25zKSwgdmFkT3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHJlc2V0VkFEKCkgewogICAgICAgICAgICB0aGlzLmlzU2lnbmFsRGV0ZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5sb3VkRnJhbWVCaXRzID0gMDsKICAgICAgICAgICAgdGhpcy5lbmVyZ3kgPSAwOwogICAgICAgICAgICB0aGlzLmJhc2VsaW5lRW5lcmd5ID0gLTE7CiAgICAgICAgfQogICAgICAgIHByb2Nlc3NGcmFtZShmbG9hdHMsIHN0YXJ0ID0gMCwgbGVuZ3RoID0gLTEsIGVvcyA9IGZhbHNlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy52YWRPcHRpb25zLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRWQUQoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZW9zKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmVuZXJneSA9IEF1ZGlvVG9vbHMuZ2V0RW5lcmd5KGZsb2F0cywgc3RhcnQsIGxlbmd0aCk7CiAgICAgICAgICAgIGlmICh0aGlzLmJhc2VsaW5lRW5lcmd5IDwgMCkgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlbGluZUVuZXJneSA9IHRoaXMuZW5lcmd5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGlzTG91ZEZyYW1lID0gdGhpcy5lbmVyZ3kgPiBNYXRoLm1heChBdWRpb1Rvb2xzLmRiVG9FbmVyZ3kodGhpcy52YWRPcHRpb25zLm5vaXNlR2F0ZURiKSwgdGhpcy5iYXNlbGluZUVuZXJneSAqIEF1ZGlvVG9vbHMuZGJUb0VuZXJneSh0aGlzLnZhZE9wdGlvbnMuc2lnbmFsVG9Ob2lzZURiKSk7CiAgICAgICAgICAgIHRoaXMucHVzaEZyYW1lSGlzdG9yeShpc0xvdWRGcmFtZSk7CiAgICAgICAgICAgIHRoaXMuaXNTaWduYWxEZXRlY3RlZCA9IHRoaXMuZGV0ZXJtaW5lTmV3U2lnbmFsU3RhdGUodGhpcy5pc1NpZ25hbERldGVjdGVkKTsKICAgICAgICAgICAgdGhpcy5hZGFwdEJhY2tncm91bmROb2lzZSgpOwogICAgICAgICAgICB0aGlzLnNpZ25hbERiID0gQXVkaW9Ub29scy5lbmVyZ3lUb0RiKHRoaXMuZW5lcmd5IC8gdGhpcy5iYXNlbGluZUVuZXJneSk7CiAgICAgICAgICAgIHRoaXMubm9pc2VMZXZlbERiID0gQXVkaW9Ub29scy5lbmVyZ3lUb0RiKHRoaXMuYmFzZWxpbmVFbmVyZ3kpOwogICAgICAgIH0KICAgICAgICBkZXRlcm1pbmVOZXdTaWduYWxTdGF0ZShjdXJyZW50U3RhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWRTdXN0YWluTWlsbGlzTGVmdCA9IE1hdGgubWF4KHRoaXMudmFkU3VzdGFpbk1pbGxpc0xlZnQgLSB0aGlzLmZyYW1lTWlsbGlzLCAwKTsKICAgICAgICAgICAgY29uc3QgbG91ZEZyYW1lcyA9IHRoaXMuY291bnRMb3VkRnJhbWVzKHRoaXMudmFkT3B0aW9ucy5zaWduYWxTZWFyY2hGcmFtZXMpOwogICAgICAgICAgICBjb25zdCBhY3RpdmF0aW9uRnJhbWVzID0gTWF0aC5yb3VuZCh0aGlzLnZhZE9wdGlvbnMuc2lnbmFsQWN0aXZhdGlvbiAqIHRoaXMudmFkT3B0aW9ucy5zaWduYWxTZWFyY2hGcmFtZXMpOwogICAgICAgICAgICBjb25zdCByZWxlYXNlRnJhbWVzID0gTWF0aC5yb3VuZCh0aGlzLnZhZE9wdGlvbnMuc2lnbmFsUmVsZWFzZSAqIHRoaXMudmFkT3B0aW9ucy5zaWduYWxTZWFyY2hGcmFtZXMpOwogICAgICAgICAgICBpZiAobG91ZEZyYW1lcyA+PSBhY3RpdmF0aW9uRnJhbWVzKSB7CiAgICAgICAgICAgICAgICAvLyBSZW5ldyBzdXN0YWluIHRpbWUKICAgICAgICAgICAgICAgIHRoaXMudmFkU3VzdGFpbk1pbGxpc0xlZnQgPSB0aGlzLnZhZE9wdGlvbnMuc2lnbmFsU3VzdGFpbk1pbGxpczsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3VkRnJhbWVzIDw9IHJlbGVhc2VGcmFtZXMgJiYgdGhpcy52YWRTdXN0YWluTWlsbGlzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50U3RhdGU7CiAgICAgICAgfQogICAgICAgIGFkYXB0QmFja2dyb3VuZE5vaXNlKCkgewogICAgICAgICAgICAvLyBHcmFkdWFsbHkgbGVhcm4gYmFja2dyb3VuZCBub2lzZSBsZXZlbAogICAgICAgICAgICBpZiAoIXRoaXMuaXNTaWduYWxEZXRlY3RlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmFkT3B0aW9ucy5ub2lzZUxlYXJuSGFsZnRpbWVNaWxsaXMgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlY2F5ID0gTWF0aC5wb3coMi4wLCAtdGhpcy5mcmFtZU1pbGxpcyAvIHRoaXMudmFkT3B0aW9ucy5ub2lzZUxlYXJuSGFsZnRpbWVNaWxsaXMpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZWxpbmVFbmVyZ3kgPSAodGhpcy5iYXNlbGluZUVuZXJneSAqIGRlY2F5KSArICh0aGlzLmVuZXJneSAqICgxIC0gZGVjYXkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwdXNoRnJhbWVIaXN0b3J5KGlzTG91ZCkgewogICAgICAgICAgICB0aGlzLmxvdWRGcmFtZUJpdHMgPSAoaXNMb3VkID8gMSA6IDApIHwgKHRoaXMubG91ZEZyYW1lQml0cyA8PCAxKTsKICAgICAgICB9CiAgICAgICAgY291bnRMb3VkRnJhbWVzKG51bUhpc3RvcnlGcmFtZXMpIHsKICAgICAgICAgICAgbGV0IG51bUFjdGl2ZUZyYW1lcyA9IDA7CiAgICAgICAgICAgIGxldCB0ID0gdGhpcy5sb3VkRnJhbWVCaXRzOwogICAgICAgICAgICB3aGlsZSAobnVtSGlzdG9yeUZyYW1lcyA+IDApIHsKICAgICAgICAgICAgICAgIGlmICgodCAmIDEpID09PSAxKQogICAgICAgICAgICAgICAgICAgIG51bUFjdGl2ZUZyYW1lcysrOwogICAgICAgICAgICAgICAgdCA9IHQgPj4gMTsKICAgICAgICAgICAgICAgIG51bUhpc3RvcnlGcmFtZXMtLTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVtQWN0aXZlRnJhbWVzOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEtub3duIFdlYlNvY2tldCByZXNwb25zZSB0eXBlcy4KICAgICAqIEBpbnRlcm5hbAogICAgICovCiAgICB2YXIgV2Vic29ja2V0UmVzcG9uc2VUeXBlOwogICAgKGZ1bmN0aW9uIChXZWJzb2NrZXRSZXNwb25zZVR5cGUpIHsKICAgICAgICBXZWJzb2NrZXRSZXNwb25zZVR5cGVbIlN0YXJ0ZWQiXSA9ICJzdGFydGVkIjsKICAgICAgICBXZWJzb2NrZXRSZXNwb25zZVR5cGVbIlN0b3BwZWQiXSA9ICJzdG9wcGVkIjsKICAgICAgICBXZWJzb2NrZXRSZXNwb25zZVR5cGVbIlNlZ21lbnRFbmQiXSA9ICJzZWdtZW50X2VuZCI7CiAgICAgICAgV2Vic29ja2V0UmVzcG9uc2VUeXBlWyJUcmFuc2NyaXB0Il0gPSAidHJhbnNjcmlwdCI7CiAgICAgICAgV2Vic29ja2V0UmVzcG9uc2VUeXBlWyJFbnRpdHkiXSA9ICJlbnRpdHkiOwogICAgICAgIFdlYnNvY2tldFJlc3BvbnNlVHlwZVsiSW50ZW50Il0gPSAiaW50ZW50IjsKICAgICAgICBXZWJzb2NrZXRSZXNwb25zZVR5cGVbIlRlbnRhdGl2ZVRyYW5zY3JpcHQiXSA9ICJ0ZW50YXRpdmVfdHJhbnNjcmlwdCI7CiAgICAgICAgV2Vic29ja2V0UmVzcG9uc2VUeXBlWyJUZW50YXRpdmVFbnRpdGllcyJdID0gInRlbnRhdGl2ZV9lbnRpdGllcyI7CiAgICAgICAgV2Vic29ja2V0UmVzcG9uc2VUeXBlWyJUZW50YXRpdmVJbnRlbnQiXSA9ICJ0ZW50YXRpdmVfaW50ZW50IjsKICAgIH0pKFdlYnNvY2tldFJlc3BvbnNlVHlwZSB8fCAoV2Vic29ja2V0UmVzcG9uc2VUeXBlID0ge30pKTsKICAgIC8qKgogICAgICogTWVzc2FnZXMgZnJvbSB3b3JrZXIgdG8gY29udHJvbGxlcgogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIHZhciBXb3JrZXJTaWduYWw7CiAgICAoZnVuY3Rpb24gKFdvcmtlclNpZ25hbCkgewogICAgICAgIFdvcmtlclNpZ25hbFsiT3BlbmVkIl0gPSAiV0VCU09DS0VUX09QRU4iOwogICAgICAgIFdvcmtlclNpZ25hbFsiQ2xvc2VkIl0gPSAiV0VCU09DS0VUX0NMT1NFRCI7CiAgICAgICAgV29ya2VyU2lnbmFsWyJBdWRpb1Byb2Nlc3NvclJlYWR5Il0gPSAiU09VUkNFX1NBTVBMRV9SQVRFX1NFVF9TVUNDRVNTIjsKICAgICAgICBXb3JrZXJTaWduYWxbIlZhZFNpZ25hbEhpZ2giXSA9ICJWYWRTaWduYWxIaWdoIjsKICAgICAgICBXb3JrZXJTaWduYWxbIlZhZFNpZ25hbExvdyJdID0gIlZhZFNpZ25hbExvdyI7CiAgICAgICAgV29ya2VyU2lnbmFsWyJSZXF1ZXN0Q29udGV4dFN0YXJ0Il0gPSAiUmVxdWVzdENvbnRleHRTdGFydCI7CiAgICB9KShXb3JrZXJTaWduYWwgfHwgKFdvcmtlclNpZ25hbCA9IHt9KSk7CiAgICAvKioKICAgICAqIE1lc3NhZ2VzIGZyb20gY29udHJvbGxlciB0byB3b3JrZXIKICAgICAqIEBpbnRlcm5hbAogICAgICovCiAgICB2YXIgQ29udHJvbGxlclNpZ25hbDsKICAgIChmdW5jdGlvbiAoQ29udHJvbGxlclNpZ25hbCkgewogICAgICAgIENvbnRyb2xsZXJTaWduYWxbImNvbm5lY3QiXSA9ICJjb25uZWN0IjsKICAgICAgICBDb250cm9sbGVyU2lnbmFsWyJpbml0QXVkaW9Qcm9jZXNzb3IiXSA9ICJpbml0QXVkaW9Qcm9jZXNzb3IiOwogICAgICAgIENvbnRyb2xsZXJTaWduYWxbImFkanVzdEF1ZGlvUHJvY2Vzc29yIl0gPSAiYWRqdXN0QXVkaW9Qcm9jZXNzb3IiOwogICAgICAgIENvbnRyb2xsZXJTaWduYWxbIlNFVF9TSEFSRURfQVJSQVlfQlVGRkVSUyJdID0gIlNFVF9TSEFSRURfQVJSQVlfQlVGRkVSUyI7CiAgICAgICAgQ29udHJvbGxlclNpZ25hbFsiQ0xPU0UiXSA9ICJDTE9TRSI7CiAgICAgICAgQ29udHJvbGxlclNpZ25hbFsiU1RBUlRfQ09OVEVYVCJdID0gIlNUQVJUX0NPTlRFWFQiOwogICAgICAgIENvbnRyb2xsZXJTaWduYWxbIlNXSVRDSF9DT05URVhUIl0gPSAiU1dJVENIX0NPTlRFWFQiOwogICAgICAgIENvbnRyb2xsZXJTaWduYWxbIlNUT1BfQ09OVEVYVCJdID0gIlNUT1BfQ09OVEVYVCI7CiAgICAgICAgQ29udHJvbGxlclNpZ25hbFsiQVVESU8iXSA9ICJBVURJTyI7CiAgICAgICAgQ29udHJvbGxlclNpZ25hbFsic3RhcnRTdHJlYW0iXSA9ICJzdGFydFN0cmVhbSI7CiAgICAgICAgQ29udHJvbGxlclNpZ25hbFsic3RvcFN0cmVhbSJdID0gInN0b3BTdHJlYW0iOwogICAgICAgIENvbnRyb2xsZXJTaWduYWxbInNldENvbnRleHRPcHRpb25zIl0gPSAic2V0Q29udGV4dE9wdGlvbnMiOwogICAgfSkoQ29udHJvbGxlclNpZ25hbCB8fCAoQ29udHJvbGxlclNpZ25hbCA9IHt9KSk7CgogICAgY29uc3QgQ09OVFJPTCA9IHsKICAgICAgICBXUklURV9JTkRFWDogMCwKICAgICAgICBGUkFNRVNfQVZBSUxBQkxFOiAxLAogICAgICAgIExPQ0s6IDIsCiAgICB9OwogICAgLyoqCiAgICAgKiBXZWIgd29ya2VyIHRvIGhhbmRsZSBzdHJlYW1pbmcgYXVkaW8gdG8gY2xvdWQgYW5kIHJlY2VpdmluZyBzcGVlY2ggcHJvY2Vzc2luZyByZXN1bHRzLgogICAgICogQWxzbyBoYW5kbGVzIGF1ZGlvIHByb2Nlc3NpbmcgbGlrZSBtYWludGFpbmluZyBoaXN0b3J5IHJpbmdidWZmZXIgYW5kIHJ1bm5pbmcgdGhlIFZBRAogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIGNsYXNzIFdlYnNvY2tldENsaWVudCB7CiAgICAgICAgY29uc3RydWN0b3IoY3R4KSB7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0U2FtcGxlUmF0ZSA9IDE2MDAwOwogICAgICAgICAgICB0aGlzLmlzQ29udGV4dFN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5hdWRpb0NvbnRleHRTdGFydFRpbWVzID0gW107CiAgICAgICAgICAgIHRoaXMuaW1tZWRpYXRlTW9kZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmZyYW1lTWlsbGlzID0gMzA7CiAgICAgICAgICAgIHRoaXMub3V0cHV0QXVkaW9GcmFtZSA9IG5ldyBJbnQxNkFycmF5KHRoaXMuZnJhbWVNaWxsaXMgKiB0aGlzLnRhcmdldFNhbXBsZVJhdGUgLyAxMDAwKTsKICAgICAgICAgICAgdGhpcy5kZWJ1ZyA9IGZhbHNlOwogICAgICAgICAgICAvLyBXZWJTb2NrZXQncyBjbG9zZSBoYW5kbGVyLCBjYWxsZWQgd2hlbiBlbmNvdW50ZXJpbmcgYSBub24gdXNlci1pbml0aWF0ZWQgY2xvc2UsIGUuZy4KICAgICAgICAgICAgLy8gLSBuZXR3b3JrIHVucmVhY2hhYmxlIG9yIHVuYWJsZSB0byAocmUpY29ubmVjdCAoY29kZSAxMDA2KQogICAgICAgICAgICAvLyBMaXN0IG9mIENsb3NlRXZlbnQuY29kZSB2YWx1ZXM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9DbG9zZUV2ZW50L2NvZGUKICAgICAgICAgICAgdGhpcy5vbldlYnNvY2tldENsb3NlID0gKGV2ZW50KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbV2ViU29ja2V0Q2xpZW50XScsICdvbldlYnNvY2tldENsb3NlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlV2Vic29ja2V0KGV2ZW50LmNvZGUsIGV2ZW50LnJlYXNvbiwgZXZlbnQud2FzQ2xlYW4sIGZhbHNlKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5vbldlYnNvY2tldE9wZW4gPSAoX2V2ZW50KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbV2ViU29ja2V0Q2xpZW50XScsICd3ZWJzb2NrZXQgb3BlbmVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLndvcmtlckN0eC5wb3N0TWVzc2FnZSh7IHR5cGU6IFdvcmtlclNpZ25hbC5PcGVuZWQgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMub25XZWJzb2NrZXRFcnJvciA9IChfZXZlbnQpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1tXZWJTb2NrZXRDbGllbnRdJywgJ3dlYnNvY2tldCBlcnJvcicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLm9uV2Vic29ja2V0TWVzc2FnZSA9IChldmVudCkgPT4gewogICAgICAgICAgICAgICAgbGV0IHJlc3BvbnNlOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXNwb25zZSA9IEpTT04ucGFyc2UoZXZlbnQuZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tXZWJTb2NrZXRDbGllbnRdJywgJ2Vycm9yIHBhcnNpbmcgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyOicsIGUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS50eXBlID09PSBXZWJzb2NrZXRSZXNwb25zZVR5cGUuU3RhcnRlZCkgewogICAgICAgICAgICAgICAgICAgIC8vIEFwcGVuZCBjbGllbnQtc2lkZSBtZXRhZGF0YSB0byB0aGUgYmFja2VuZCBtZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgbGV0IGF1ZGlvQ29udGV4dFN0YXJ0VGltZSA9IHRoaXMuYXVkaW9Db250ZXh0U3RhcnRUaW1lcy5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIGlmIChhdWRpb0NvbnRleHRTdGFydFRpbWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ05vIHZhbGlkIHZhbHVlIGZvciBjb250ZXh0U3RhcnRNaWxsaXMnKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9Db250ZXh0U3RhcnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnRDb250ZXh0UGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgICAgICBhdWRpb1N0YXJ0VGltZU1pbGxpczogYXVkaW9Db250ZXh0U3RhcnRUaW1lLAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UucGFyYW1zID0gc3RhcnRDb250ZXh0UGFyYW1zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy53b3JrZXJDdHgucG9zdE1lc3NhZ2UocmVzcG9uc2UpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLndvcmtlckN0eCA9IGN0eDsKICAgICAgICB9CiAgICAgICAgY29ubmVjdChhcGlVcmwsIGF1dGhUb2tlbiwgdGFyZ2V0U2FtcGxlUmF0ZSwgZGVidWcpIHsKICAgICAgICAgICAgdGhpcy5kZWJ1ZyA9IGRlYnVnOwogICAgICAgICAgICBpZiAodGhpcy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1tXZWJTb2NrZXRDbGllbnRdJywgJ2Nvbm5lY3RpbmcgdG8gJywgYXBpVXJsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnRhcmdldFNhbXBsZVJhdGUgPSB0YXJnZXRTYW1wbGVSYXRlOwogICAgICAgICAgICB0aGlzLmlzQ29udGV4dFN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy53ZWJzb2NrZXQgPSBuZXcgV2ViU29ja2V0KGFwaVVybCwgYXV0aFRva2VuKTsKICAgICAgICAgICAgdGhpcy53ZWJzb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcignb3BlbicsIHRoaXMub25XZWJzb2NrZXRPcGVuKTsKICAgICAgICAgICAgdGhpcy53ZWJzb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIHRoaXMub25XZWJzb2NrZXRNZXNzYWdlKTsKICAgICAgICAgICAgdGhpcy53ZWJzb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcignZXJyb3InLCB0aGlzLm9uV2Vic29ja2V0RXJyb3IpOwogICAgICAgICAgICB0aGlzLndlYnNvY2tldC5hZGRFdmVudExpc3RlbmVyKCdjbG9zZScsIHRoaXMub25XZWJzb2NrZXRDbG9zZSk7CiAgICAgICAgfQogICAgICAgIGluaXRBdWRpb1Byb2Nlc3Nvcihzb3VyY2VTYW1wbGVSYXRlLCBmcmFtZU1pbGxpcywgaGlzdG9yeUZyYW1lcywgdmFkT3B0aW9ucykgewogICAgICAgICAgICB0aGlzLmF1ZGlvUHJvY2Vzc29yID0gbmV3IEF1ZGlvUHJvY2Vzc29yKHNvdXJjZVNhbXBsZVJhdGUsIHRoaXMudGFyZ2V0U2FtcGxlUmF0ZSwgZnJhbWVNaWxsaXMsIGhpc3RvcnlGcmFtZXMpOwogICAgICAgICAgICBpZiAodmFkT3B0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb1Byb2Nlc3Nvci52YWQgPSBuZXcgRW5lcmd5VHJlc2hvbGRWQUQoZnJhbWVNaWxsaXMsIHZhZE9wdGlvbnMpOwogICAgICAgICAgICAgICAgdGhpcy5hdWRpb1Byb2Nlc3Nvci5vblZhZFN0YXRlQ2hhbmdlID0gKGlzU2lnbmFsRGV0ZWN0ZWQpID0+IHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2EsIF9iOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRWYWRPcHRpb25zID0gKF9iID0gKF9hID0gdGhpcy5hdWRpb1Byb2Nlc3NvcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnZhZCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnZhZE9wdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50VmFkT3B0aW9ucykKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGlmIChpc1NpZ25hbERldGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbW1lZGlhdGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndvcmtlckN0eC5wb3N0TWVzc2FnZSh7IHR5cGU6IFdvcmtlclNpZ25hbC5WYWRTaWduYWxIaWdoIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGN1cnJlbnRWYWRPcHRpb25zLmNvbnRyb2xMaXN0ZW5pbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRDb250ZXh0KHRoaXMuZGVmYXVsdENvbnRleHRPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWlzU2lnbmFsRGV0ZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmltbWVkaWF0ZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMud29ya2VyQ3R4LnBvc3RNZXNzYWdlKHsgdHlwZTogV29ya2VyU2lnbmFsLlZhZFNpZ25hbExvdyB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChjdXJyZW50VmFkT3B0aW9ucy5jb250cm9sTGlzdGVuaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3BDb250ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYXVkaW9Qcm9jZXNzb3Iub25TZW5kQXVkaW8gPSAoZmxvYXRzLCBzdGFydEluZGV4LCBsZW5ndGgpID0+IHsKICAgICAgICAgICAgICAgIEF1ZGlvVG9vbHMuY29udmVydEZsb2F0VG9JbnQxNihmbG9hdHMsIHRoaXMub3V0cHV0QXVkaW9GcmFtZSwgc3RhcnRJbmRleCwgbGVuZ3RoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2VuZCh0aGlzLm91dHB1dEF1ZGlvRnJhbWUpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAodGhpcy53b3JrZXJDdHggPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy53b3JrZXJDdHgucG9zdE1lc3NhZ2UoeyB0eXBlOiBXb3JrZXJTaWduYWwuQXVkaW9Qcm9jZXNzb3JSZWFkeSB9KTsKICAgICAgICB9CiAgICAgICAgLyoqCiAgICAgICAgICogQ29udHJvbCBhdWRpbyBwcm9jZXNzb3IgcGFyYW1ldGVycwogICAgICAgICAqIEBwYXJhbSBhcCAtIEF1ZGlvIHByb2Nlc3NvciBwYXJhbWV0ZXJzIHRvIGFkanVzdAogICAgICAgICAqLwogICAgICAgIGFkanVzdEF1ZGlvUHJvY2Vzc29yKGFwKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvUHJvY2Vzc29yICYmIGFwLnZhZCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmF1ZGlvUHJvY2Vzc29yLnZhZCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gVkFEIGluIEF1ZGlvUHJvY2Vzc29yLiBEaWQgeW91IGRlZmluZSBgdmFkYCBpbiBCcm93c2VyQ2xpZW50IGNvbnN0cnVjdG9yIHBhcmFtZXRlcnM/Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvUHJvY2Vzc29yLnZhZC5hZGp1c3RWYWRPcHRpb25zKGFwLnZhZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2V0U2hhcmVkQXJyYXlCdWZmZXJzKGNvbnRyb2xTQUIsIGRhdGFTQUIpIHsKICAgICAgICAgICAgdGhpcy5jb250cm9sU0FCID0gbmV3IEludDMyQXJyYXkoY29udHJvbFNBQik7CiAgICAgICAgICAgIHRoaXMuZGF0YVNBQiA9IG5ldyBGbG9hdDMyQXJyYXkoZGF0YVNBQik7CiAgICAgICAgICAgIGNvbnN0IGF1ZGlvSGFuZGxlSW50ZXJ2YWwgPSB0aGlzLmRhdGFTQUIubGVuZ3RoIC8gMzI7IC8vIG1zCiAgICAgICAgICAgIGlmICh0aGlzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW1dlYlNvY2tldENsaWVudF0nLCAnQXVkaW8gaGFuZGxlIGludGVydmFsJywgYXVkaW9IYW5kbGVJbnRlcnZhbCwgJ21zJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SW50ZXJ2YWwodGhpcy5wcm9jZXNzQXVkaW9TQUIuYmluZCh0aGlzKSwgYXVkaW9IYW5kbGVJbnRlcnZhbCk7CiAgICAgICAgfQogICAgICAgIHN0YXJ0U3RyZWFtKHN0cmVhbU9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmF1ZGlvUHJvY2Vzc29yKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIEF1ZGlvUHJvY2Vzc29yJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pbW1lZGlhdGVNb2RlID0gc3RyZWFtT3B0aW9ucy5pbW1lZGlhdGU7CiAgICAgICAgICAgIHRoaXMuYXVkaW9Qcm9jZXNzb3IucmVzZXQoc3RyZWFtT3B0aW9ucy5zYW1wbGVSYXRlKTsKICAgICAgICAgICAgdGhpcy5hdWRpb0NvbnRleHRTdGFydFRpbWVzID0gW107CiAgICAgICAgfQogICAgICAgIHN0b3BTdHJlYW0oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hdWRpb1Byb2Nlc3NvcikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBBdWRpb1Byb2Nlc3NvcicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNlbmQgRU9TLiBFbnN1cmUgVkFEIHdpbGwgZ28gb2ZmIGF0IGVuZCBvZiBzdHJlYW0gYW5kIHN0b3BDb250ZXh0IGlzIGNhbGxlZCBpbiBpbW1lZGlhdGUgbW9kZQogICAgICAgICAgICB0aGlzLmF1ZGlvUHJvY2Vzc29yLmVvcygpOwogICAgICAgIH0KICAgICAgICAvKioKICAgICAgICAgKiBQcm9jZXNzZXMgYW5kIHNlbmRzIGF1ZGlvCiAgICAgICAgICogQHBhcmFtIGF1ZGlvQ2h1bmsgLSBhdWRpbyBkYXRhIHRvIHByb2Nlc3MKICAgICAgICAgKi8KICAgICAgICBwcm9jZXNzQXVkaW8oYXVkaW9DaHVuaykgewogICAgICAgICAgICBpZiAoIXRoaXMuYXVkaW9Qcm9jZXNzb3IpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gQXVkaW9Qcm9jZXNzb3InKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmF1ZGlvUHJvY2Vzc29yLnByb2Nlc3NBdWRpbyhhdWRpb0NodW5rKTsKICAgICAgICB9CiAgICAgICAgcHJvY2Vzc0F1ZGlvU0FCKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udHJvbFNBQiB8fCAhdGhpcy5kYXRhU0FCKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIFNoYXJlZEFycmF5QnVmZmVycycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGZyYW1lc0F2YWlsYWJsZSA9IHRoaXMuY29udHJvbFNBQltDT05UUk9MLkZSQU1FU19BVkFJTEFCTEVdOwogICAgICAgICAgICBjb25zdCBsb2NrID0gdGhpcy5jb250cm9sU0FCW0NPTlRST0wuTE9DS107CiAgICAgICAgICAgIGlmIChsb2NrID09PSAwICYmIGZyYW1lc0F2YWlsYWJsZSA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGFTQUIuc3ViYXJyYXkoMCwgZnJhbWVzQXZhaWxhYmxlKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbFNBQltDT05UUk9MLkZSQU1FU19BVkFJTEFCTEVdID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbFNBQltDT05UUk9MLldSSVRFX0lOREVYXSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzQXVkaW8oZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc3RhcnRDb250ZXh0KGNvbnRleHRPcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBfYTsKICAgICAgICAgICAgaWYgKCF0aGlzLmF1ZGlvUHJvY2Vzc29yKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignTm8gQXVkaW9Qcm9jZXNzb3InKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5pc0NvbnRleHRTdGFydGVkKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbV2ViU29ja2V0Q2xpZW50XScsICJjYW4ndCBzdGFydCBjb250ZXh0OiBhY3RpdmUgY29udGV4dCBleGlzdHMiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmF1ZGlvUHJvY2Vzc29yLnNldFNlbmRBdWRpbyh0cnVlKTsKICAgICAgICAgICAgdGhpcy5pc0NvbnRleHRTdGFydGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5hdWRpb0NvbnRleHRTdGFydFRpbWVzLnB1c2godGhpcy5hdWRpb1Byb2Nlc3Nvci5nZXRTdHJlYW1Qb3NpdGlvbigpKTsKICAgICAgICAgICAgdGhpcy53b3JrZXJDdHgucG9zdE1lc3NhZ2UoeyB0eXBlOiBXb3JrZXJTaWduYWwuUmVxdWVzdENvbnRleHRTdGFydCB9KTsKICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSAoX2EgPSB0aGlzLmRlZmF1bHRDb250ZXh0T3B0aW9ucykgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDoge307CiAgICAgICAgICAgIGlmIChjb250ZXh0T3B0aW9ucyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKSwgY29udGV4dE9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBjb250ZXh0T3B0aW9uc1RvTXNnKG9wdGlvbnMpOwogICAgICAgICAgICBtZXNzYWdlLmV2ZW50ID0gJ3N0YXJ0JzsKICAgICAgICAgICAgdGhpcy5zZW5kKEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKTsKICAgICAgICB9CiAgICAgICAgc3RvcENvbnRleHQoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hdWRpb1Byb2Nlc3NvcikgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ05vIEF1ZGlvUHJvY2Vzc29yJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLmlzQ29udGV4dFN0YXJ0ZWQpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tXZWJTb2NrZXRDbGllbnRdJywgImNhbid0IHN0b3AgY29udGV4dDogbm8gYWN0aXZlIGNvbnRleHQiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmF1ZGlvUHJvY2Vzc29yLnNldFNlbmRBdWRpbyhmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuaXNDb250ZXh0U3RhcnRlZCA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBTdG9wRXZlbnRKU09OID0gSlNPTi5zdHJpbmdpZnkoeyBldmVudDogJ3N0b3AnIH0pOwogICAgICAgICAgICB0aGlzLnNlbmQoU3RvcEV2ZW50SlNPTik7CiAgICAgICAgfQogICAgICAgIHN3aXRjaENvbnRleHQoY29udGV4dE9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLndlYnNvY2tldCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ1dlYlNvY2tldCBpcyB1bmRlZmluZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMuaXNDb250ZXh0U3RhcnRlZCkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignW1dlYlNvY2tldENsaWVudF0nLCAiY2FuJ3Qgc3dpdGNoIGNvbnRleHQ6IG5vIGFjdGl2ZSBjb250ZXh0Iik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChjb250ZXh0T3B0aW9ucyA9PT0gbnVsbCB8fCBjb250ZXh0T3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogY29udGV4dE9wdGlvbnMuYXBwSWQpID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tXZWJTb2NrZXRDbGllbnRdJywgImNhbid0IHN3aXRjaCBjb250ZXh0OiBuZXcgYXBwIGlkIGlzIHVuZGVmaW5lZCIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IFN0b3BFdmVudEpTT04gPSBKU09OLnN0cmluZ2lmeSh7IGV2ZW50OiAnc3RvcCcgfSk7CiAgICAgICAgICAgIHRoaXMuc2VuZChTdG9wRXZlbnRKU09OKTsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGNvbnRleHRPcHRpb25zVG9Nc2coY29udGV4dE9wdGlvbnMpOwogICAgICAgICAgICBtZXNzYWdlLmV2ZW50ID0gJ3N0YXJ0JzsKICAgICAgICAgICAgdGhpcy5zZW5kKEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKTsKICAgICAgICB9CiAgICAgICAgY2xvc2VXZWJzb2NrZXQoY29kZSA9IDEwMDUsIHJlYXNvbiA9ICdObyBTdGF0dXMgUmVjZWl2ZWQnLCB3YXNDbGVhbiA9IHRydWUsIHVzZXJJbml0aWF0ZWQgPSB0cnVlKSB7CiAgICAgICAgICAgIHZhciBfYTsKICAgICAgICAgICAgaWYgKCF0aGlzLndlYnNvY2tldCkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdXZWJTb2NrZXQgYWxyZWFkeSBjbG9zZWQnKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW1dlYlNvY2tldENsaWVudF0nLCB1c2VySW5pdGlhdGVkID8gJ1dlYnNvY2tldCBjbG9zZSByZXF1ZXN0ZWQnIDogJ1dlYnNvY2tldCBjbG9zZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBSZXNldCBhdWRpb3Byb2Nlc3NvciBzbyBpdCB3b24ndCB0cnkgdG8gc2VuZCBhdWRpbyB0aGUgZmlyc3QgdGhpbmcgd2hlbiByZWNvbm5lY3QgaGFwcGVucy4gVGhpcyB3aWxsIGxlYWQgdG8gYSByZWNvbm5lY3QgbG9vcC4KICAgICAgICAgICAgKF9hID0gdGhpcy5hdWRpb1Byb2Nlc3NvcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlc2V0KCk7CiAgICAgICAgICAgIC8vIFdlIGRvbid0IHdhbnQgYW55IG1vcmUgbWVzc2FnZXMgZnJvbSB0aGUgY2xvc2luZyB3ZWJzb2NrZXQKICAgICAgICAgICAgdGhpcy53ZWJzb2NrZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignb3BlbicsIHRoaXMub25XZWJzb2NrZXRPcGVuKTsKICAgICAgICAgICAgdGhpcy53ZWJzb2NrZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIHRoaXMub25XZWJzb2NrZXRNZXNzYWdlKTsKICAgICAgICAgICAgdGhpcy53ZWJzb2NrZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignZXJyb3InLCB0aGlzLm9uV2Vic29ja2V0RXJyb3IpOwogICAgICAgICAgICB0aGlzLndlYnNvY2tldC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbG9zZScsIHRoaXMub25XZWJzb2NrZXRDbG9zZSk7CiAgICAgICAgICAgIC8vIElmIHdlJ3JlIGhlcmUgZHVlIHRvIGEgY2FsbCB0byBvbldlYlNvY2tldAogICAgICAgICAgICBpZiAodXNlckluaXRpYXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy53ZWJzb2NrZXQuY2xvc2UoY29kZSwgcmVhc29uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLndlYnNvY2tldCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdGhpcy53b3JrZXJDdHgucG9zdE1lc3NhZ2UoewogICAgICAgICAgICAgICAgdHlwZTogV29ya2VyU2lnbmFsLkNsb3NlZCwKICAgICAgICAgICAgICAgIGNvZGUsCiAgICAgICAgICAgICAgICByZWFzb24sCiAgICAgICAgICAgICAgICB3YXNDbGVhbiwKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHNlbmQoZGF0YSkgewogICAgICAgICAgICBpZiAoIXRoaXMud2Vic29ja2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIFdlYnNvY2tldCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLndlYnNvY2tldC5yZWFkeVN0YXRlICE9PSB0aGlzLndlYnNvY2tldC5PUEVOKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYEV4cGVjdGVkIE9QRU4gV2Vic29ja2V0IHN0YXRlLCBidXQgZ290ICR7dGhpcy53ZWJzb2NrZXQucmVhZHlTdGF0ZX1gKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhpcy53ZWJzb2NrZXQuc2VuZChkYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbV2ViU29ja2V0Q2xpZW50XScsICdzZXJ2ZXIgY29ubmVjdGlvbiBlcnJvcicsIGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRDb250ZXh0T3B0aW9ucyhvcHRpb25zKSB7CiAgICAgICAgICAgIHRoaXMuZGVmYXVsdENvbnRleHRPcHRpb25zID0gb3B0aW9uczsKICAgICAgICB9CiAgICB9CiAgICBjb25zdCBjdHggPSBzZWxmOwogICAgY29uc3Qgd2Vic29ja2V0Q2xpZW50ID0gbmV3IFdlYnNvY2tldENsaWVudChjdHgpOwogICAgY3R4Lm9ubWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgc3dpdGNoIChlLmRhdGEudHlwZSkgewogICAgICAgICAgICBjYXNlIENvbnRyb2xsZXJTaWduYWwuY29ubmVjdDoKICAgICAgICAgICAgICAgIHdlYnNvY2tldENsaWVudC5jb25uZWN0KGUuZGF0YS5hcGlVcmwsIGUuZGF0YS5hdXRoVG9rZW4sIGUuZGF0YS50YXJnZXRTYW1wbGVSYXRlLCBlLmRhdGEuZGVidWcpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udHJvbGxlclNpZ25hbC5pbml0QXVkaW9Qcm9jZXNzb3I6CiAgICAgICAgICAgICAgICB3ZWJzb2NrZXRDbGllbnQuaW5pdEF1ZGlvUHJvY2Vzc29yKGUuZGF0YS5zb3VyY2VTYW1wbGVSYXRlLCBlLmRhdGEuZnJhbWVNaWxsaXMsIGUuZGF0YS5oaXN0b3J5RnJhbWVzLCBlLmRhdGEudmFkT3B0aW9ucyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250cm9sbGVyU2lnbmFsLmFkanVzdEF1ZGlvUHJvY2Vzc29yOgogICAgICAgICAgICAgICAgd2Vic29ja2V0Q2xpZW50LmFkanVzdEF1ZGlvUHJvY2Vzc29yKGUuZGF0YS5wYXJhbXMpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udHJvbGxlclNpZ25hbC5TRVRfU0hBUkVEX0FSUkFZX0JVRkZFUlM6CiAgICAgICAgICAgICAgICB3ZWJzb2NrZXRDbGllbnQuc2V0U2hhcmVkQXJyYXlCdWZmZXJzKGUuZGF0YS5jb250cm9sU0FCLCBlLmRhdGEuZGF0YVNBQik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250cm9sbGVyU2lnbmFsLkNMT1NFOgogICAgICAgICAgICAgICAgd2Vic29ja2V0Q2xpZW50LmNsb3NlV2Vic29ja2V0KDEwMDAsICdDbG9zZSByZXF1ZXN0ZWQgYnkgY2xpZW50JywgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250cm9sbGVyU2lnbmFsLnN0YXJ0U3RyZWFtOgogICAgICAgICAgICAgICAgd2Vic29ja2V0Q2xpZW50LnN0YXJ0U3RyZWFtKGUuZGF0YS5zdHJlYW1PcHRpb25zKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRyb2xsZXJTaWduYWwuc3RvcFN0cmVhbToKICAgICAgICAgICAgICAgIHdlYnNvY2tldENsaWVudC5zdG9wU3RyZWFtKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250cm9sbGVyU2lnbmFsLlNUQVJUX0NPTlRFWFQ6CiAgICAgICAgICAgICAgICB3ZWJzb2NrZXRDbGllbnQuc3RhcnRDb250ZXh0KGUuZGF0YS5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRyb2xsZXJTaWduYWwuU1dJVENIX0NPTlRFWFQ6CiAgICAgICAgICAgICAgICB3ZWJzb2NrZXRDbGllbnQuc3dpdGNoQ29udGV4dChlLmRhdGEub3B0aW9ucyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250cm9sbGVyU2lnbmFsLlNUT1BfQ09OVEVYVDoKICAgICAgICAgICAgICAgIHdlYnNvY2tldENsaWVudC5zdG9wQ29udGV4dCgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udHJvbGxlclNpZ25hbC5BVURJTzoKICAgICAgICAgICAgICAgIHdlYnNvY2tldENsaWVudC5wcm9jZXNzQXVkaW8oZS5kYXRhLnBheWxvYWQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udHJvbGxlclNpZ25hbC5zZXRDb250ZXh0T3B0aW9uczoKICAgICAgICAgICAgICAgIHdlYnNvY2tldENsaWVudC5zZXRDb250ZXh0T3B0aW9ucyhlLmRhdGEub3B0aW9ucyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdXT1JLRVInLCBlKTsKICAgICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gY29udGV4dE9wdGlvbnNUb01zZyhjb250ZXh0T3B0aW9ucykgewogICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB7CiAgICAgICAgICAgIG9wdGlvbnM6IHsKICAgICAgICAgICAgICAgIHRpbWV6b25lOiBbSW50bC5EYXRlVGltZUZvcm1hdCgpLnJlc29sdmVkT3B0aW9ucygpLnRpbWVab25lXSwKICAgICAgICAgICAgfSwKICAgICAgICB9OwogICAgICAgIGlmIChjb250ZXh0T3B0aW9ucyA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgICBtZXNzYWdlLm9wdGlvbnMudm9jYWJ1bGFyeSA9IGNvbnRleHRPcHRpb25zLnZvY2FidWxhcnk7CiAgICAgICAgbWVzc2FnZS5vcHRpb25zLnZvY2FidWxhcnlfYmlhcyA9IGNvbnRleHRPcHRpb25zLnZvY2FidWxhcnlCaWFzOwogICAgICAgIG1lc3NhZ2Uub3B0aW9ucy5zaWxlbmNlX3RyaWdnZXJlZF9zZWdtZW50YXRpb24gPSBjb250ZXh0T3B0aW9ucy5zaWxlbmNlVHJpZ2dlcmVkU2VnbWVudGF0aW9uOwogICAgICAgIGlmIChjb250ZXh0T3B0aW9ucy5ub25TdHJlYW1pbmdObHUpIHsKICAgICAgICAgICAgbWVzc2FnZS5vcHRpb25zLm5vbl9zdHJlYW1pbmdfbmx1ID0gWyd5ZXMnXTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIG1lc3NhZ2Uub3B0aW9ucy5ub25fc3RyZWFtaW5nX25sdSA9IFsnbm8nXTsKICAgICAgICB9CiAgICAgICAgaWYgKChjb250ZXh0T3B0aW9ucyA9PT0gbnVsbCB8fCBjb250ZXh0T3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogY29udGV4dE9wdGlvbnMudGltZXpvbmUpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgbWVzc2FnZS5vcHRpb25zLnRpbWV6b25lID0gY29udGV4dE9wdGlvbnMgPT09IG51bGwgfHwgY29udGV4dE9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNvbnRleHRPcHRpb25zLnRpbWV6b25lOyAvLyBvdmVycmlkZSBicm93c2VyIHRpbWV6b25lCiAgICAgICAgfQogICAgICAgIGlmIChjb250ZXh0T3B0aW9ucy5hcHBJZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIG1lc3NhZ2UuYXBwSWQgPSBjb250ZXh0T3B0aW9ucy5hcHBJZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICB9CgogICAgZXhwb3J0cy5jb250ZXh0T3B0aW9uc1RvTXNnID0gY29udGV4dE9wdGlvbnNUb01zZzsKICAgIGV4cG9ydHNbImRlZmF1bHQiXSA9IFdlYnNvY2tldENsaWVudDsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pOwoKICAgIHJldHVybiBleHBvcnRzOwoKfSkoe30pOwoK",null,false),new Worker(i,t)}}();class qt{onResponse(t){this.onResponseCb=t}onClose(t){this.onCloseCb=t}constructor(){this.startCbs=[],this.stopCbs=[],this.onResponseCb=()=>{},this.onCloseCb=()=>{},this.onWebsocketMessage=t=>{const e=t.data;switch(e.type){case Rt.Opened:this.onInitResolve&&this.onInitResolve();break;case Rt.Closed:const g=new Zt(t.data.reason,t.data.code,t.data.wasClean);this.onInitReject?this.onInitReject(g):this.onCloseCb(g);break;case Rt.AudioProcessorReady:null!=this.resolveSourceSampleRateSet&&this.resolveSourceSampleRateSet();break;case Vt.Started:this.onResponseCb(e),this.startCbs.forEach((t=>{try{t(void 0,e.audio_context)}catch(t){console.error('[SpeechlyClient] Error while invoking "onStart" callback:',t)}})),this.startCbs.length=0;break;case Vt.Stopped:this.onResponseCb(e),this.stopCbs.forEach((t=>{try{t(void 0,e.audio_context)}catch(t){console.error('[SpeechlyClient] Error while invoking "onStop" callback:',t)}})),this.stopCbs.length=0;break;default:this.onResponseCb(e)}},this.worker=new _t,this.worker.addEventListener("message",this.onWebsocketMessage)}initialize(t,e,g,i){return vt(this,void 0,void 0,(function*(){return this.worker.postMessage({type:ft.connect,apiUrl:t,authToken:e,targetSampleRate:g,debug:i}),this.startCbs=[],this.stopCbs=[],new Promise(((t,e)=>{this.onInitResolve=()=>{this.onInitResolve=void 0,this.onInitReject=void 0,t()},this.onInitReject=t=>{this.onInitResolve=void 0,this.onInitReject=void 0,e(t)}}))}))}initAudioProcessor(t,e,g,i){return vt(this,void 0,void 0,(function*(){return this.worker.postMessage({type:ft.initAudioProcessor,sourceSampleRate:t,frameMillis:e,historyFrames:g,vadOptions:i}),new Promise((t=>{this.resolveSourceSampleRateSet=t}))}))}adjustAudioProcessor(t){this.worker.postMessage({type:ft.adjustAudioProcessor,params:t})}close(){return vt(this,void 0,void 0,(function*(){return new Promise(((t,e)=>{this.worker.postMessage({type:ft.CLOSE,code:1e3,message:"Client has ended the session"}),t()}))}))}startStream(t){return vt(this,void 0,void 0,(function*(){this.worker.postMessage({type:ft.startStream,streamOptions:t})}))}stopStream(){return vt(this,void 0,void 0,(function*(){this.worker.postMessage({type:ft.stopStream})}))}startContext(t){return vt(this,void 0,void 0,(function*(){return new Promise(((e,g)=>{this.startCbs.push(((t,i)=>{void 0!==t?g(t):e(i)})),this.worker.postMessage({type:ft.START_CONTEXT,options:t})}))}))}stopContext(){return vt(this,void 0,void 0,(function*(){return new Promise(((t,e)=>{this.stopCbs.push(((g,i)=>{void 0!==g?e(g):t(i)})),this.worker.postMessage({type:ft.STOP_CONTEXT})}))}))}switchContext(t){return vt(this,void 0,void 0,(function*(){return new Promise(((e,g)=>{this.startCbs.push(((t,i)=>{void 0!==t?g(t):e(i)})),this.worker.postMessage({type:ft.SWITCH_CONTEXT,options:t})}))}))}postMessage(t){this.worker.postMessage(t)}sendAudio(t){this.worker.postMessage({type:ft.AUDIO,payload:t})}setContextOptions(t){return vt(this,void 0,void 0,(function*(){this.worker.postMessage({type:ft.setContextOptions,options:t})}))}}class te{constructor(){this.storage=window.localStorage}get(t){return this.storage.getItem(t)}set(t,e){this.storage.setItem(t,e)}getOrSet(t,e){let g=this.storage.getItem(t);return null===g&&(g=e(),this.storage.setItem(t,g)),g}}function ee(t,e){return{intent:t.intent,isFinal:e}}const ge="speechly-auth-token";class ie{constructor(t){var e,g;if(this.streamOptions=Nt,this.activeContexts=0,this.audioContexts=new Map,this.maxReconnectAttemptCount=10,this.connectAttempt=0,this.connectPromise=null,this.cbs=[],this.state=Yt.Disconnected,this.handleWebsocketResponse=t=>{var e;switch(this.debug&&console.log("[Decoder]","Received response",t),t.type){case Rt.VadSignalHigh:this.cbs.forEach((t=>t.onVadStateChange.forEach((t=>t(!0)))));break;case Rt.VadSignalLow:this.cbs.forEach((t=>t.onVadStateChange.forEach((t=>t(!1)))));break;case Rt.RequestContextStart:this.activeContexts++;break;case Vt.Started:{const g=t.params;this.audioContexts.set(t.audio_context,{segments:new Map,audioStartTimeMillis:null!==(e=null==g?void 0:g.audioStartTimeMillis)&&void 0!==e?e:0}),this.cbs.forEach((e=>e.contextStartedCbs.forEach((e=>e(t.audio_context)))));break}case Vt.Stopped:this.activeContexts--,this.cbs.forEach((e=>e.contextStoppedCbs.forEach((e=>e(t.audio_context))))),this.streamOptions.preserveSegments||this.audioContexts.delete(t.audio_context),void 0!==this.resolveStopStream&&0===this.activeContexts&&this.resolveStopStream();break;default:this.handleSegmentUpdate(t)}},this.handleSegmentUpdate=t=>{var e;const{audio_context:g,segment_id:i,type:n}=t;let{data:I}=t;const C=this.audioContexts.get(g);if(void 0===C)return void console.warn("[Decoder]","Received response for non-existent context",g);let o=null!==(e=C.segments.get(i))&&void 0!==e?e:new yt(g,i);switch(n){case Vt.TentativeTranscript:const t=function(t,e){return t.words.map((({word:t,index:g,start_timestamp:i,end_timestamp:n})=>({value:t,index:g,startTimestamp:i+e,endTimestamp:n+e,isFinal:!1})))}(I,C.audioStartTimeMillis),e=I.transcript;this.cbs.forEach((n=>n.tentativeTranscriptCbs.forEach((n=>n(g,i,t,e))))),o=o.updateTranscript(t);break;case Vt.Transcript:const n=function(t,e){return{value:t.word,index:t.index,startTimestamp:t.start_timestamp+e,endTimestamp:t.end_timestamp+e,isFinal:!0}}(I,C.audioStartTimeMillis);this.cbs.forEach((t=>t.transcriptCbs.forEach((t=>t(g,i,n))))),o=o.updateTranscript([n]);break;case Vt.TentativeEntities:const s=function(t){return t.entities.map((({entity:t,value:e,start_position:g,end_position:i})=>({type:t,value:e,startPosition:g,endPosition:i,isFinal:!1})))}(I);this.cbs.forEach((t=>t.tentativeEntityCbs.forEach((t=>t(g,i,s))))),o=o.updateEntities(s);break;case Vt.Entity:const A=function(t){return{type:t.entity,value:t.value,startPosition:t.start_position,endPosition:t.end_position,isFinal:!0}}(I);this.cbs.forEach((t=>t.entityCbs.forEach((t=>t(g,i,A))))),o=o.updateEntities([A]);break;case Vt.TentativeIntent:const a=ee(I,!1);this.cbs.forEach((t=>t.tentativeIntentCbs.forEach((t=>t(g,i,a))))),o=o.updateIntent(a);break;case Vt.Intent:const c=ee(I,!0);this.cbs.forEach((t=>t.intentCbs.forEach((t=>t(g,i,c))))),o=o.updateIntent(c);break;case Vt.SegmentEnd:o=o.finalize()}C.segments.set(i,o),this.audioContexts.set(g,C),this.logSegments&&console.info(o.toString()),this.cbs.forEach((t=>t.segmentChangeCbs.forEach((t=>t(o.toSegment())))))},this.handleWebsocketClosure=t=>{if(1e3===t.code)this.debug&&console.log("[Decoder]","Websocket closed",t);else{if(console.error("[Decoder]","Websocket closed due to error",t),void 0===this.deviceId)return this.setState(Yt.Failed),void console.error("[Decoder]","No deviceId. Giving up reconnecting.");this.setState(Yt.Disconnected),this.activeContexts=0,this.audioContexts.clear(),this.reconnect()}},this.logSegments=t.logSegments,this.appId=t.appId,this.projectId=t.projectId,this.sampleRate=t.sampleRate,this.debug=t.debug,void 0!==this.appId&&void 0!==this.projectId)throw Error("[Decoder] You cannot use both appId and projectId at the same time");if(void 0===this.appId&&void 0===this.projectId)throw Error("[Decoder] Either an appId or a projectId is required");const i=t.apiUrl;this.apiUrl=function(t,e){const g=new URLSearchParams;return g.append("sampleRate",e.toString()),`${t}?${g.toString()}`}(i.replace("http","ws")+"/ws/v1",this.sampleRate),this.loginUrl=`${i}/login`;try{this.storage=null!==(e=t.storage)&&void 0!==e?e:new te,this.deviceId=this.storage.getOrSet("speechly-device-id",$t)}catch(t){this.deviceId=$t()}this.apiClient=new qt,this.apiClient.onResponse(this.handleWebsocketResponse),this.apiClient.onClose(this.handleWebsocketClosure),(null===(g=t.connect)||void 0===g||g)&&this.connect()}getReconnectDelayMs(t){return 100*Math.pow(2,t)}sleep(t){return vt(this,void 0,void 0,(function*(){return new Promise((e=>setTimeout(e,t)))}))}connect(){return vt(this,void 0,void 0,(function*(){null===this.connectPromise&&(this.connectPromise=(()=>vt(this,void 0,void 0,(function*(){var t;this.setState(Yt.Disconnected);const e=null===(t=this.storage)||void 0===t?void 0:t.get(ge);if(e&&Pt(e,this.projectId,this.appId,this.deviceId))this.authToken=e;else try{this.authToken=yield function(t,e,g,i,n=fetch,I=Date.now){var C;return vt(this,void 0,void 0,(function*(){let o;o=void 0!==e?{projectId:e,deviceId:i}:{appId:g,deviceId:i};const s=yield n(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),A=yield s.json();if(200!==s.status)throw Error(null!==(C=A.error)&&void 0!==C?C:`Speechly API login request failed with ${s.status}`);if(void 0===A.access_token)throw Error("Invalid login response from Speechly API");if(!Pt(A.access_token,e,g,i,I))throw Error("Invalid token received from Speechly API");return A.access_token}))}(this.loginUrl,this.projectId,this.appId,this.deviceId,fetch),this.storage&&this.storage.set(ge,this.authToken)}catch(t){throw this.connectPromise=null,this.setState(Yt.Failed),t}try{yield this.apiClient.initialize(this.apiUrl,this.authToken,this.sampleRate,this.debug)}catch(t){throw this.connectPromise=null,t instanceof Zt&&1e3===t.code||this.setState(Yt.Failed),t}this.advanceState(Yt.Connected)})))()),yield this.connectPromise}))}adjustAudioProcessor(t){this.apiClient.adjustAudioProcessor(t)}close(){return vt(this,void 0,void 0,(function*(){let t;try{yield this.apiClient.close()}catch(e){t=e.message}if(this.audioContexts.clear(),this.activeContexts=0,this.connectPromise=null,this.setState(Yt.Disconnected),void 0!==t)throw Error(t)}))}startStream(t){return vt(this,void 0,void 0,(function*(){this.debug&&console.log("[Decoder]","startStream"),this.streamOptions=t,this.audioContexts.clear(),this.activeContexts=0,yield this.apiClient.startStream(t)}))}stopStream(){return vt(this,void 0,void 0,(function*(){this.debug&&console.log("[Decoder]","stopStream"),yield this.apiClient.stopStream(),yield this.waitResults()}))}waitResults(){return vt(this,void 0,void 0,(function*(){if(this.activeContexts>0){const t=new Promise((t=>{this.resolveStopStream=t}));yield t}this.resolveStopStream=void 0}))}startContext(t){return vt(this,void 0,void 0,(function*(){if(this.state===Yt.Failed)throw Error("[Decoder] startContext cannot be run in Failed state.");if(this.state<Yt.Connected)yield this.connect();else if(this.state>Yt.Connected)throw Error("[Decoder] Unable to complete startContext: Expected Connected state, but was in "+Ht(this.state)+".");let e;if(this.setState(Yt.Active),null!=this.projectId){if(!(null==t?void 0:t.appId))throw new Error("options.appId is required with project login");e=yield this.apiClient.startContext(t)}else{if(null!=(null==t?void 0:t.appId)&&this.appId!==(null==t?void 0:t.appId))throw this.setState(Yt.Failed),mt;e=yield this.apiClient.startContext(t)}if(this.state<Yt.Active)throw Error("[Decoder] Unable to complete startContext: Problem acquiring contextId");return e}))}sendAudio(t){this.apiClient.sendAudio(t)}stopContext(t){return vt(this,void 0,void 0,(function*(){if(this.state===Yt.Failed)throw Error("[Decoder] stopContext cannot be run in unrecovable error state.");if(this.state!==Yt.Active)throw Error("[Decoder] Unable to complete stopContext: Expected Active state, but was in "+Ht(this.state)+".");t>0&&(yield this.sleep(t));const e=yield this.apiClient.stopContext();return this.setState(Yt.Connected),e}))}switchContext(t){return vt(this,void 0,void 0,(function*(){if(this.state!==Yt.Active)throw Error("[Decoder] Unable to complete switchContext: Expected Active state, but was in "+Ht(this.state)+".");return yield this.apiClient.switchContext(t)}))}registerListener(t){this.cbs.push(t)}initAudioProcessor(t,e,g,i){return vt(this,void 0,void 0,(function*(){yield this.apiClient.initAudioProcessor(t,e,g,i)}))}useSharedArrayBuffers(t,e){this.apiClient.postMessage({type:"SET_SHARED_ARRAY_BUFFERS",controlSAB:t,dataSAB:e})}setContextOptions(t){return vt(this,void 0,void 0,(function*(){yield this.apiClient.setContextOptions(t)}))}reconnect(){return vt(this,void 0,void 0,(function*(){console.log("Speechly reconnecting"),this.connectPromise=null,this.connectAttempt<this.maxReconnectAttemptCount?(yield this.sleep(this.getReconnectDelayMs(this.connectAttempt++)),yield this.connect()):console.error("[Decoder] Maximum reconnect count reached, giving up automatic reconnect.")}))}advanceState(t){this.state>=t||this.setState(t)}setState(t){this.state!==t&&(this.debug&&console.log("[Decoder]",Ht(this.state),"->",Ht(t)),this.state=t,this.cbs.forEach((e=>{var g;return null===(g=e.stateChangeCbs)||void 0===g?void 0:g.forEach((e=>e(t)))})))}getSegments(){const t=[];return this.audioContexts.forEach(((e,g)=>{e.segments.forEach(((e,g)=>{const i=JSON.parse(JSON.stringify(e));t.push(i)}))})),t}}var ne,Ie,Ce,oe,se,Ae;class ae{constructor(t){var e,g;this.contextStopDelay=250,this.debug=!1,this.initialized=!1,this.audioProcessorInitialized=!1,this.isStreaming=!1,this.active=!1,this.listeningPromise=null,this.streamOptions=Object.assign({},Nt),this.stats={maxSignalEnergy:0,sentSamples:0},this.decoderOptions=Object.assign(Object.assign(Object.assign({},Xt),t),{vad:t.vad?Object.assign(Object.assign({},St),t.vad):void 0});const i=window.navigator.mediaDevices.getSupportedConstraints();this.nativeResamplingSupported=!0===i.sampleRate,this.isMobileSafari=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].indexOf(navigator.platform)>=0||navigator.userAgent.includes("Mac")&&"ontouchend"in document,this.isSafari=this.isMobileSafari||void 0!==window.safari,this.useSAB=!this.isSafari,this.debug=null===(e=this.decoderOptions.debug)||void 0===e||e,this.callbacks=new xt,this.callbacks.stateChangeCbs.addEventListener(this.handleStateChange.bind(this)),this.callbacks.onVadStateChange.addEventListener(this.autoControlListening.bind(this)),this.decoder=null!==(g=this.decoderOptions.decoder)&&void 0!==g?g:new ie(this.decoderOptions),this.decoder.registerListener(this.callbacks)}initialize(t){var e,g;return vt(this,void 0,void 0,(function*(){if(!this.initialized){this.debug&&console.log("[BrowserClient]","initializing"),this.initialized=!0;try{yield this.decoder.connect()}catch(t){if(this.initialized=!1,t instanceof Zt){if(1e3===t.code)return void(this.debug&&console.log("[BrowserClient]","Early close of websocket."));throw Error(`Unable to connect. Most likely there is no connection to network. Websocket error code: ${t.code}`)}throw t}try{const t={};if(this.nativeResamplingSupported&&(t.sampleRate=Gt),void 0!==window.webkitAudioContext)try{this.audioContext=new window.webkitAudioContext(t)}catch(t){this.debug&&console.log("[BrowserClient]","creating audioContext without samplerate conversion",t),this.audioContext=new window.webkitAudioContext}else this.audioContext=new window.AudioContext(t),void 0!==window.webkitAudioContext&&(yield this.audioContext.resume())}catch(t){throw this.initialized=!1,pt}if(this.isSafari||void 0===window.AudioWorkletNode){if(this.debug&&console.log("[BrowserClient]","using ScriptProcessorNode"),void 0!==window.webkitAudioContext){const t=this.audioContext.sampleRate/Gt,e=4096*Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)));this.audioProcessor=this.audioContext.createScriptProcessor(e,1,1)}else this.audioProcessor=this.audioContext.createScriptProcessor(void 0,1,1);this.audioProcessor.connect(this.audioContext.destination),this.audioProcessor.addEventListener("audioprocess",(t=>{this.handleAudio(t.inputBuffer.getChannelData(0))}))}else{this.debug&&console.log("[BrowserClient]","using AudioWorkletNode");const t=new Blob(["\n// Indices for the Control SAB.\nconst CONTROL = {\n  'WRITE_INDEX': 0,\n  'FRAMES_AVAILABLE': 1,\n  'LOCK': 2,\n};\n\nclass SpeechlyProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n\n    this._initialized = false;\n    this.debug = false;\n    this.port.onmessage = this._initialize.bind(this);\n  }\n\n  _initialize(event) {\n    this.controlSAB = new Int32Array(event.data.controlSAB);\n    this.dataSAB = new Float32Array(event.data.dataSAB);\n    this.debug = event.data.debug;\n    if (this.debug) {\n      console.log('[BrowserClient AudioWorkletNode]', 'initializing audioworklet');\n    }\n    this.sharedBufferSize = this.dataSAB.length;\n    this.buffer = new Float32Array(0);\n    this._initialized = true;\n  }\n\n  _transferDataToSharedBuffer(data) {\n    this.controlSAB[CONTROL.LOCK] = 1;\n    let inputWriteIndex = this.controlSAB[CONTROL.WRITE_INDEX];\n    if (this.controlSAB[CONTROL.FRAMES_AVAILABLE] > 0) {\n      if (inputWriteIndex + data.length > this.sharedBufferSize) {\n        // console.log('buffer overflow')\n        inputWriteIndex = 0;\n      }\n    }\n    this.dataSAB.set(data, inputWriteIndex);\n    this.controlSAB[CONTROL.WRITE_INDEX] = inputWriteIndex + data.length;\n    this.controlSAB[CONTROL.FRAMES_AVAILABLE] = inputWriteIndex + data.length;\n    this.controlSAB[CONTROL.LOCK] = 0;\n  }\n\n  _pushData(data) {\n    if (this.debug) {\n      const signalEnergy = getStandardDeviation(data)\n      this.port.postMessage({\n        type: 'STATS',\n        signalEnergy: signalEnergy,\n        samples: data.length,\n      });\n    }\n\n    if (this.buffer.length > this.sharedBufferSize) {\n      const dataToTransfer = this.buffer.subarray(0, this.sharedBufferSize);\n      this._transferDataToSharedBuffer(dataToTransfer);\n      this.buffer = this.buffer.subarray(this.sharedBufferSize);\n    }\n    let concat = new Float32Array(this.buffer.length + data.length);\n    concat.set(this.buffer);\n    concat.set(data, this.buffer.length);\n    this.buffer = concat;\n  }\n\n  process(inputs, outputs, parameters) {\n    const inputChannelData = inputs[0][0];\n    if (inputChannelData !== undefined) {\n      if (this.controlSAB && this.dataSAB) {\n        this._pushData(inputChannelData);\n      } else {\n        this.port.postMessage({\n          type: 'DATA',\n          frames: inputChannelData\n        });\n      }\n    }\n\n    return true;\n  }\n}\n\nfunction getStandardDeviation(array) {\n  const n = array.length\n  const mean = array.reduce((a, b) => a + b) / n\n  return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n)\n}\n\nregisterProcessor('speechly-worklet', SpeechlyProcessor);\n"],{type:"text/javascript"}),e=window.URL.createObjectURL(t);if(yield this.audioContext.audioWorklet.addModule(e),this.speechlyNode=new AudioWorkletNode(this.audioContext,"speechly-worklet"),this.speechlyNode.connect(this.audioContext.destination),this.useSAB&&void 0!==window.SharedArrayBuffer){this.debug&&console.log("[BrowserClient]","using SharedArrayBuffer");const t=new window.SharedArrayBuffer(4*Int32Array.BYTES_PER_ELEMENT),e=new window.SharedArrayBuffer(1024*Float32Array.BYTES_PER_ELEMENT);this.decoder.useSharedArrayBuffers(t,e),this.speechlyNode.port.postMessage({type:"SET_SHARED_ARRAY_BUFFERS",controlSAB:t,dataSAB:e,debug:this.debug})}else this.debug&&console.log("[BrowserClient]","can not use SharedArrayBuffer");this.speechlyNode.port.onmessage=t=>{switch(t.data.type){case"STATS":t.data.signalEnergy>this.stats.maxSignalEnergy&&(this.stats.maxSignalEnergy=t.data.signalEnergy),this.stats.sentSamples+=parseInt(t.data.samples);break;case"DATA":this.handleAudio(t.data.frames)}}}this.debug&&console.log("[BrowserClient]","audioContext sampleRate is",null===(e=this.audioContext)||void 0===e?void 0:e.sampleRate),this.streamOptions.sampleRate=null===(g=this.audioContext)||void 0===g?void 0:g.sampleRate,yield this.decoder.initAudioProcessor(this.streamOptions.sampleRate,this.decoderOptions.frameMillis,this.decoderOptions.historyFrames,this.decoderOptions.vad),this.audioProcessorInitialized=!0,(null==t?void 0:t.mediaStream)&&(yield this.attach(null==t?void 0:t.mediaStream))}}))}attach(t){var e,g,i,n,I,C;return vt(this,void 0,void 0,(function*(){if(yield this.initialize(),yield this.detach(),this.stream=null===(e=this.audioContext)||void 0===e?void 0:e.createMediaStreamSource(t),"running"!==(null===(g=this.audioContext)||void 0===g?void 0:g.state)&&(this.debug&&console.log("[BrowserClient]","audioContext resume required, state is",null===(i=this.audioContext)||void 0===i?void 0:i.state),yield null===(n=this.audioContext)||void 0===n?void 0:n.resume()),this.speechlyNode)null===(I=this.stream)||void 0===I||I.connect(this.speechlyNode);else{if(!this.audioProcessor)throw Error("[BrowserClient] cannot attach to mediaStream, not initialized");null===(C=this.stream)||void 0===C||C.connect(this.audioProcessor)}yield this.autoControlStream()}))}isActive(){return this.active}start(t){return vt(this,void 0,void 0,(function*(){if(this.active)throw Ft;return this.active=!0,yield this.queueTask((()=>vt(this,void 0,void 0,(function*(){return yield this.initialize(),this.isStreaming||(yield this.startStream({autoStarted:!0})),yield this.decoder.startContext(t)}))))}))}stop(t=this.contextStopDelay){return vt(this,void 0,void 0,(function*(){if(!this.active)throw kt;return this.active=!1,yield this.queueTask((()=>vt(this,void 0,void 0,(function*(){var e;try{const g=yield this.decoder.stopContext(t);return!(null===(e=this.decoderOptions.vad)||void 0===e?void 0:e.enabled)&&this.isStreaming&&this.streamOptions.autoStarted&&(yield this.stopStream()),0===this.stats.sentSamples&&console.warn("[BrowserClient]","audioContext contained no audio data"),g}catch(t){console.warn("[BrowserClient]","stop() failed",t)}finally{this.stats.sentSamples=0}}))))}))}setContextOptions(t){return vt(this,void 0,void 0,(function*(){yield this.decoder.setContextOptions(t)}))}adjustAudioProcessor(t){var e;if(t.vad){if(!this.decoderOptions.vad)throw Error("Unable to adjust VAD - it was not defined in the constructor");this.decoderOptions.vad=Object.assign(Object.assign({},this.decoderOptions.vad),t.vad)}this.decoder.adjustAudioProcessor(t),(null===(e=this.decoderOptions.vad)||void 0===e?void 0:e.enabled)?this.autoControlStream():this.active&&this.stop()}uploadAudioData(t,e){var g,i,n;return vt(this,void 0,void 0,(function*(){yield this.initialize();const I=yield null===(g=this.audioContext)||void 0===g?void 0:g.decodeAudioData(t);if(void 0===I)throw Error("Could not decode audioData");const C=I.getChannelData(0);if(I.numberOfChannels>1){const t=I.getChannelData(1);for(let e=0;e<C.length;e++)C[e]=(C[e]+t[e])/2}this.active&&(yield this.stop(0)),this.isStreaming&&(yield this.stopStream()),yield this.startStream({sampleRate:I.sampleRate,preserveSegments:!0,immediate:!0});const o=(null===(i=this.decoderOptions.vad)||void 0===i?void 0:i.enabled)&&(null===(n=this.decoderOptions.vad)||void 0===n?void 0:n.controlListening),s=1e3;let A,a=0;o?(e&&(yield this.setContextOptions(e)),this.decoderOptions.vad.signalSustainMillis>=s?a=s/(10/(1e4/this.decoderOptions.vad.signalSustainMillis)):console.warn("Throttling disabled due to low (<= 1000) VAD sustain value. Server may disconnect while processing if contexts are created at high rate."),a=0):yield this.start(e);const c=Math.round(I.sampleRate*s/1e3);for(let t=0;t<C.length;t+=c){const e=t+c;A=e>C.length?C.slice(t):C.slice(t,e),this.handleAudio(A),yield this.sleep(a)}return o||(yield this.stop(0)),yield this.stopStream(),this.decoder.getSegments()}))}startStream(t){return vt(this,void 0,void 0,(function*(){this.streamOptions=Object.assign(Object.assign(Object.assign({},this.streamOptions),{autoStarted:!1}),t),yield this.decoder.startStream(this.streamOptions),this.isStreaming=!0}))}stopStream(){return vt(this,void 0,void 0,(function*(){this.isStreaming&&(this.isStreaming=!1,yield this.decoder.stopStream())}))}queueTask(t){return vt(this,void 0,void 0,(function*(){const e=this.listeningPromise;return this.listeningPromise=(()=>vt(this,void 0,void 0,(function*(){return yield e,t()})))(),this.listeningPromise}))}autoControlListening(t){var e;this.debug&&console.log("[BrowserClient]","autoControlListening",t),(null===(e=this.decoderOptions.vad)||void 0===e?void 0:e.controlListening)&&(t?this.active||this.start():this.active&&this.stop(0))}autoControlStream(){var t,e;return vt(this,void 0,void 0,(function*(){this.audioProcessorInitialized&&this.stream&&(!(null===(t=this.decoderOptions.vad)||void 0===t?void 0:t.enabled)||this.isStreaming?!(null===(e=this.decoderOptions.vad)||void 0===e?void 0:e.enabled)&&this.isStreaming&&this.streamOptions.autoStarted&&(yield this.stopStream()):yield this.startStream({autoStarted:!0}))}))}handleStateChange(t){switch(t){case Yt.Disconnected:case Yt.Failed:this.stopStream(),this.active=!1,this.listeningPromise=null}}detach(){return vt(this,void 0,void 0,(function*(){this.active&&(yield this.stop(0)),this.stream&&(this.stream.disconnect(),this.stream=void 0)}))}close(){var t,e,g;return vt(this,void 0,void 0,(function*(){this.debug&&console.log("[BrowserClient]","close"),yield this.detach(),null!==this.speechlyNode&&(null===(t=this.speechlyNode)||void 0===t||t.port.close(),null===(e=this.speechlyNode)||void 0===e||e.disconnect()),void 0!==this.audioProcessor&&(null===(g=this.audioProcessor)||void 0===g||g.disconnect()),yield this.decoder.close(),this.initialized=!1,this.listeningPromise=null}))}sleep(t){return vt(this,void 0,void 0,(function*(){return new Promise((e=>setTimeout(e,t)))}))}handleAudio(t){this.isStreaming&&(this.stats.sentSamples+=t.length,this.decoder.sendAudio(t))}onStart(t){this.callbacks.contextStartedCbs.addEventListener(t)}onStop(t){this.callbacks.contextStoppedCbs.addEventListener(t)}onSegmentChange(t){this.callbacks.segmentChangeCbs.addEventListener(t)}onTranscript(t){this.callbacks.transcriptCbs.addEventListener(t)}onEntity(t){this.callbacks.entityCbs.addEventListener(t)}onIntent(t){this.callbacks.intentCbs.addEventListener(t)}onTentativeTranscript(t){this.callbacks.tentativeTranscriptCbs.addEventListener(t)}onTentativeEntities(t){this.callbacks.tentativeEntityCbs.addEventListener(t)}onTentativeIntent(t){this.callbacks.tentativeIntentCbs.addEventListener(t)}onStateChange(t){this.callbacks.stateChangeCbs.addEventListener(t)}}!function(t){t.SpeechlyFirstConnect="SpeechlyFirstConnect"}(ne||(ne={})),function(t){t.speechlypoweron="speechlypoweron",t.holdstart="holdstart",t.holdend="holdend",t.speechstate="speechstate",t.audiosourcestate="audiosourcestate",t.speechsegment="speechsegment",t.speechhandled="speechhandled",t.showhint="showhint",t.transcriptdrawerhint="hint",t.speechlyintroready="speechlyintroready",t.speechlyintroclosed="speechlyintroclosed",t.startcontext="startcontext",t.stopcontext="stopcontext",t.requeststartmicrophone="requeststartmicrophone"}(Ie||(Ie={})),function(t){t.Mic="mic",t.MicActive="micactive",t.Error="error",t.Denied="denied"}(Ce||(Ce={})),function(t){t.Hold="hold",t.Click="click",t.Noninteractive="noninteractive"}(oe||(oe={})),function(t){t.None="none",t.Connecting="connecting",t.Busy="busy"}(se||(se={})),function(t){t.None="none",t.Whirl="whirl"}(Ae||(Ae={}));const ce={[Yt.Disconnected]:{icon:"mic",behaviour:"click",effect:"none",triggerFx:"whirl"},[Yt.Connected]:{icon:"mic",behaviour:"hold",effect:"none",triggerFx:"whirl"},[Yt.Active]:{icon:"micactive",behaviour:"hold",effect:"none"},[Yt.Failed]:{icon:"error",behaviour:"click",effect:"none"},[wt.NoBrowserSupport]:{icon:"error",behaviour:"click",effect:"none"},[wt.NoAudioConsent]:{icon:"denied",behaviour:"click",effect:"none"}};function le(t){b(t,"svelte-s2u2hd",".Icon.svelte-s2u2hd{position:absolute;width:var(--icon-size);height:var(--icon-size);top:50%;left:50%;transform:translate(-50%, -50%);pointer-events:none;transition:0.25s;opacity:var(--icon-opacity)}")}function de(t){let e,g,i,n,I,C,o,s,A,a,c,l,d;return{c(){e=W("svg"),g=W("linearGradient"),i=W("animate"),n=W("animate"),I=W("stop"),C=W("stop"),o=W("stop"),s=W("stop"),A=W("stop"),a=w(">\n  "),c=W("g"),l=W("path"),d=W("rect"),B(i,"attributeName","y1"),B(i,"values","-200%; 0%;"),B(i,"dur","2s"),B(i,"repeatCount","indefinite"),B(n,"attributeName","y2"),B(n,"values","200%; 400%;"),B(n,"dur","2s"),B(n,"repeatCount","indefinite"),B(I,"offset","0%"),B(I,"stop-color","var(--gradient-stop1)"),B(C,"offset","25%"),B(C,"stop-color","var(--gradient-stop2)"),B(o,"offset","50%"),B(o,"stop-color","var(--gradient-stop1)"),B(s,"offset","75%"),B(s,"stop-color","var(--gradient-stop2)"),B(A,"offset","100%"),B(A,"stop-color","var(--gradient-stop1)"),B(g,"id","gradient"),B(g,"x1","50%"),B(g,"y1","-200%"),B(g,"x2","50%"),B(g,"y2","200%"),B(l,"d","M42 26h4v4c0 9.265-7 16.895-16 17.89V55h-4v-7.11c-8.892-.982-15.833-8.444-15.997-17.56L10 30v-4h4v4c0 7.732 6.268 14 14 14 7.628 0 13.83-6.1 13.997-13.687L42 30v-4z"),B(d,"x","20"),B(d,"y","1"),B(d,"width","16"),B(d,"height","37"),B(d,"rx","8"),B(c,"fill","url(#gradient)"),B(c,"fill-rule","evenodd"),B(e,"class","Icon svelte-s2u2hd"),B(e,"viewBox","0 0 56 56"),B(e,"xmlns","http://www.w3.org/2000/svg")},m(t,r){G(t,e,r),u(e,g),u(g,i),u(g,n),u(g,I),u(g,C),u(g,o),u(g,s),u(g,A),u(e,a),u(e,c),u(c,l),u(c,d)},d(t){t&&y(e)}}}function re(t){let e,g,i,n;return{c(){e=W("svg"),g=W("g"),i=W("path"),n=W("rect"),B(i,"d","M42 26h4v4c0 9.265-7 16.895-16 17.89V55h-4v-7.11c-8.892-.982-15.833-8.444-15.997-17.56L10 30v-4h4v4c0 7.732 6.268 14 14 14 7.628 0 13.83-6.1 13.997-13.687L42 30v-4z"),B(n,"x","20"),B(n,"y","1"),B(n,"width","16"),B(n,"height","37"),B(n,"rx","8"),B(g,"fill","var(--icon-color)"),B(g,"fill-rule","evenodd"),B(e,"class","Icon svelte-s2u2hd"),B(e,"viewBox","0 0 56 56"),B(e,"xmlns","http://www.w3.org/2000/svg")},m(t,I){G(t,e,I),u(e,g),u(g,i),u(g,n)},d(t){t&&y(e)}}}function he(t){let e,g,i,n;return{c(){e=W("svg"),g=W("g"),i=W("path"),n=W("path"),B(i,"d","M42 26h4v4c0 9.265-7 16.895-16 17.89V55h-4v-7.11c-8.892-.982-15.833-8.444-15.997-17.56L10 30v-4h4v4c0 7.732 6.268 14 14 14 7.628 0 13.83-6.1 13.997-13.687L42 30v-4z"),B(i,"fill-rule","nonzero"),B(n,"d","M37 13.081V31a8 8 0 11-16 0v-1.919l16-16zM26 1a8 8 0 018 8v1.319L18 26.318V9a8 8 0 018-8zM37.969 7.932l3.74-7.35 3.018 2.625zM39.654 10.608l7.531-3.359.695 3.94z"),B(g,"fill","var(--icon-color)"),B(g,"fill-rule","evenodd"),B(e,"class","Icon svelte-s2u2hd"),B(e,"viewBox","0 0 56 56"),B(e,"xmlns","http://www.w3.org/2000/svg")},m(t,I){G(t,e,I),u(e,g),u(g,i),u(g,n)},d(t){t&&y(e)}}}function ue(t){let e,g,i,n;return{c(){e=W("svg"),g=W("g"),i=W("path"),n=W("path"),B(i,"d","M36 14.828V30a8 8 0 01-15.961.79l15.96-15.962zM28 1a8 8 0 018 8v.172L20 25.173V9a8 8 0 018-8z"),B(n,"d","M42 26h4v4c0 9.265-7 16.895-16 17.89V55h-4v-7.11c-8.892-.982-15.833-8.444-15.997-17.56L10 30v-4h4v4c0 7.732 6.268 14 14 14 7.628 0 13.83-6.1 13.997-13.687L42 30v-4z"),B(g,"fill","var(--icon-color)"),B(g,"fill-rule","nonzero"),B(e,"class","Icon svelte-s2u2hd"),B(e,"viewBox","0 0 56 56"),B(e,"xmlns","http://www.w3.org/2000/svg")},m(t,I){G(t,e,I),u(e,g),u(g,i),u(g,n)},d(t){t&&y(e)}}}function be(e){let g,i,n,I,C=e[0]===Ce.MicActive&&de(),o=e[0]===Ce.Mic&&re(),s=e[0]===Ce.Error&&he(),A=e[0]===Ce.Denied&&ue();return{c(){C&&C.c(),g=V(),o&&o.c(),i=V(),s&&s.c(),n=V(),A&&A.c(),I=R()},m(t,e){C&&C.m(t,e),G(t,g,e),o&&o.m(t,e),G(t,i,e),s&&s.m(t,e),G(t,n,e),A&&A.m(t,e),G(t,I,e)},p(t,[e]){t[0]===Ce.MicActive?C||(C=de(),C.c(),C.m(g.parentNode,g)):C&&(C.d(1),C=null),t[0]===Ce.Mic?o||(o=re(),o.c(),o.m(i.parentNode,i)):o&&(o.d(1),o=null),t[0]===Ce.Error?s||(s=he(),s.c(),s.m(n.parentNode,n)):s&&(s.d(1),s=null),t[0]===Ce.Denied?A||(A=ue(),A.c(),A.m(I.parentNode,I)):A&&(A.d(1),A=null)},i:t,o:t,d(t){C&&C.d(t),t&&y(g),o&&o.d(t),t&&y(i),s&&s.d(t),t&&y(n),A&&A.d(t),t&&y(I)}}}function pe(t,e,g){let{icon:i=Ce.Mic}=e;return t.$$set=t=>{"icon"in t&&g(0,i=t.icon)},[i]}class me extends dt{constructor(t){super(),ct(this,t,pe,be,o,{icon:0},le)}}function Ze(t){b(t,"svelte-1fpkb0k",".Fx.svelte-1fpkb0k{position:absolute;width:var(--fx-size);height:var(--fx-size);top:50%;left:50%;transform-origin:50% 50%;transform:translate(-50%, -50%) rotate(var(--fx-rotation));pointer-events:none;opacity:var(--fx-opacity)}")}function Ge(e){let g,i,n,I,C,o,s,A;return{c(){g=W("svg"),i=W("defs"),n=W("linearGradient"),I=W("stop"),C=W("stop"),o=W("filter"),s=W("feGaussianBlur"),A=W("circle"),B(I,"stop-color","var(--fx-gradient-stop1)"),B(I,"offset","0%"),B(C,"stop-color","var(--fx-gradient-stop2)"),B(C,"offset","100%"),B(n,"x1","50%"),B(n,"y1","10%"),B(n,"x2","50%"),B(n,"y2","100%"),B(n,"id","a"),B(s,"stdDeviation","18"),B(s,"in","SourceGraphic"),B(o,"x","-35%"),B(o,"y","-35%"),B(o,"width","170%"),B(o,"height","170%"),B(o,"filterUnits","objectBoundingBox"),B(o,"id","b"),B(A,"filter","url(#b)"),B(A,"cx","124"),B(A,"cy","124"),B(A,"r","79"),B(A,"fill","url(#a)"),B(A,"fillrule","evenodd"),B(g,"class","Fx svelte-1fpkb0k"),B(g,"viewBox","0 0 246 246"),B(g,"xmlns","http://www.w3.org/2000/svg")},m(t,e){G(t,g,e),u(g,i),u(i,n),u(n,I),u(n,C),u(i,o),u(o,s),u(g,A)},p:t,i:t,o:t,d(t){t&&y(g)}}}class ye extends dt{constructor(t){super(),ct(this,t,null,Ge,o,{},Ze)}}const{window:ve}=ot;function We(t){let e;return{c(){e=v("link"),B(e,"href",t[9]),B(e,"rel","stylesheet")},m(t,g){G(t,e,g)},p(t,g){512&g[0]&&B(e,"href",t[9])},d(t){t&&y(e)}}}function we(e){let g,i,n,C,o,s,A,a,c,l,d,r,h=void 0!==e[9]&&We(e);return n=new ye({}),o=new bt({props:{frameRadius:e[16]}}),A=new me({props:{icon:e[15].icon}}),{c(){h&&h.c(),g=V(),i=v("main"),st(n.$$.fragment),C=V(),st(o.$$.fragment),s=V(),st(A.$$.fragment),a=V(),c=v("slot"),this.c=t,B(i,"class","HoldableButton"),S(i,"width",e[0]),S(i,"height",e[0]),S(i,"--gradient-stop1",e[5]),S(i,"--gradient-stop2",e[6]),S(i,"--fx-gradient-stop1",e[7]||e[5]),S(i,"--fx-gradient-stop2",e[8]||e[6]),S(i,"--fx-rotation",e[11][1]+"deg"),S(i,"--fx-opacity",e[14][1]),S(i,"--fx-size",e[2]),S(i,"--icon-opacity",e[13][1]),S(i,"--icon-size",e[1]),S(i,"--icon-color",e[4]),S(i,"--frame-stroke-width",e[17]),S(i,"--frame-background",e[3]),S(i,"transform","scale("+e[12][1]+")"),N(i,"pressed",e[10])},m(t,I){h&&h.m(t,I),G(t,g,I),G(t,i,I),At(n,i,null),u(i,C),At(o,i,null),u(i,s),At(A,i,null),u(i,a),u(i,c),l=!0,d||(r=[f(ve,"mouseup",e[19]),f(ve,"keydown",e[20]),f(ve,"keyup",e[21]),f(i,"mousedown",e[18]),f(i,"touchstart",e[18]),f(i,"dragstart",e[18]),f(i,"mouseup",e[19]),f(i,"touchend",e[19],{passive:!0}),f(i,"dragend",e[19])],d=!0)},p(t,e){void 0!==t[9]?h?h.p(t,e):(h=We(t),h.c(),h.m(g.parentNode,g)):h&&(h.d(1),h=null);const n={};65536&e[0]&&(n.frameRadius=t[16]),o.$set(n);const I={};32768&e[0]&&(I.icon=t[15].icon),A.$set(I),(!l||1&e[0])&&S(i,"width",t[0]),(!l||1&e[0])&&S(i,"height",t[0]),(!l||32&e[0])&&S(i,"--gradient-stop1",t[5]),(!l||64&e[0])&&S(i,"--gradient-stop2",t[6]),(!l||160&e[0])&&S(i,"--fx-gradient-stop1",t[7]||t[5]),(!l||320&e[0])&&S(i,"--fx-gradient-stop2",t[8]||t[6]),(!l||2048&e[0])&&S(i,"--fx-rotation",t[11][1]+"deg"),(!l||16384&e[0])&&S(i,"--fx-opacity",t[14][1]),(!l||4&e[0])&&S(i,"--fx-size",t[2]),(!l||8192&e[0])&&S(i,"--icon-opacity",t[13][1]),(!l||2&e[0])&&S(i,"--icon-size",t[1]),(!l||16&e[0])&&S(i,"--icon-color",t[4]),(!l||131072&e[0])&&S(i,"--frame-stroke-width",t[17]),(!l||8&e[0])&&S(i,"--frame-background",t[3]),(!l||4096&e[0])&&S(i,"transform","scale("+t[12][1]+")"),(!l||1024&e[0])&&N(i,"pressed",t[10])},i(t){l||(nt(n.$$.fragment,t),nt(o.$$.fragment,t),nt(A.$$.fragment,t),l=!0)},o(t){It(n.$$.fragment,t),It(o.$$.fragment,t),It(A.$$.fragment,t),l=!1},d(t){h&&h.d(t),t&&y(g),t&&y(i),at(n),at(o),at(A),d=!1,I(r)}}}function Ve(t,e,g){let i,n,I,C,{icon:o=Yt.Disconnected}=e,{capturekey:s=" "}=e,{hide:A}=e,{size:a="80px"}=e,{holdscale:c="1.35"}=e,{borderscale:l="0.075"}=e,{iconsize:d="60%"}=e,{fxsize:r="250%"}=e,{backgroundcolor:h="#ffffff"}=e,{iconcolor:u="#000000"}=e,{gradientstop1:b="#15e8b5"}=e,{gradientstop2:p="#4fa1f9"}=e,{fxgradientstop1:m}=e,{fxgradientstop2:Z}=e,{customcssurl:G}=e,y=!1,v=0,W=[0,0],w=[0,0],V=[1,1],R=[0,0],f=ce[o],B=null,X=0,S=0;const N=K(),Y=(t,e)=>{N.dispatchEvent(new CustomEvent(t,{detail:e,composed:!0}))};T((()=>{g(12,w=[1,0]);let t=null;const e=()=>{X=S,S=(new Date).getTime();const n=S-(X||S);f.effect===se.Connecting&&g(13,V[0]=.25*Math.cos(S/2500*Math.PI*2)+.25,V),f.effect===se.Busy&&g(13,V[0]=.25*Math.cos(S/1e3*Math.PI*2)+.25,V),g(12,w=[w[0],F(w[1],i?w[0]:0,.2,n)]),g(13,V=[V[0],F(V[1],V[0],.08,n)]),g(14,R=[R[0],F(R[1],R[0],.08,n)]),g(11,W=[W[0]+2.5,F(W[1],W[0],.05,n)]),t=requestAnimationFrame(e)};return e(),()=>cancelAnimationFrame(t)}));const z=t=>{t.preventDefault(),t.stopPropagation(),i&&!y&&(g(10,y=!0),v=Date.now(),k(),f.triggerFx===Ae.Whirl&&g(11,W[0]+=720,W),f.behaviour===oe.Click&&null===B&&(B=window.setTimeout((()=>{g(14,R[0]=0,R),B=null}),500)),N.onholdstart&&N.onholdstart(),Y(Ie.holdstart))},x=()=>{if(y){g(10,y=!1);const t={timeMs:Date.now()-v};k(),null!==B&&window.clearTimeout(B),N.onholdend&&N.onholdend(t),Y("holdend",t)}},F=(t,e,g,i)=>t*(1-(g=Math.pow(g,1e3/60/i)))+e*g,k=(t=5)=>{void 0!==navigator.vibrate&&navigator.vibrate(t)};return t.$$set=t=>{"icon"in t&&g(22,o=t.icon),"capturekey"in t&&g(23,s=t.capturekey),"hide"in t&&g(24,A=t.hide),"size"in t&&g(0,a=t.size),"holdscale"in t&&g(25,c=t.holdscale),"borderscale"in t&&g(26,l=t.borderscale),"iconsize"in t&&g(1,d=t.iconsize),"fxsize"in t&&g(2,r=t.fxsize),"backgroundcolor"in t&&g(3,h=t.backgroundcolor),"iconcolor"in t&&g(4,u=t.iconcolor),"gradientstop1"in t&&g(5,b=t.gradientstop1),"gradientstop2"in t&&g(6,p=t.gradientstop2),"fxgradientstop1"in t&&g(7,m=t.fxgradientstop1),"fxgradientstop2"in t&&g(8,Z=t.fxgradientstop2),"customcssurl"in t&&g(9,G=t.customcssurl)},t.$$.update=()=>{16777216&t.$$.dirty[0]&&(i=void 0===A||"false"===A),67108864&t.$$.dirty[0]&&g(17,n=""+46*l),67108864&t.$$.dirty[0]&&g(16,I=46-23*l),33554432&t.$$.dirty[0]&&(C=c),4195328&t.$$.dirty[0]&&((t,e)=>{switch(g(15,f=ce[e]),g(12,w[0]=t?C:1,w),g(14,R[0]=t||e==Yt.Active?1:0,R),f.icon){case Ce.MicActive:case Ce.Mic:case Ce.Denied:case Ce.Error:g(13,V[0]=1,V)}})(y,o)},[a,d,r,h,u,b,p,m,Z,G,y,W,w,V,R,f,I,n,z,x,t=>{s&&t.key===s&&(document.hasFocus()&&document.activeElement!==document.body&&document.activeElement!==document.documentElement&&document.activeElement||(t.repeat?(t.preventDefault(),t.stopPropagation()):z(t)))},t=>{t.key===s&&x()},o,s,A,c,l,()=>y]}function Re(g){let i,n,o,s,A,a,l,d,r,b;return{c(){i=v("div"),n=v("div"),n.innerHTML="<slot></slot>",o=V(),s=v("div"),A=V(),B(n,"class","CalloutDiv"),N(n,"useShadow",Be),B(s,"class","ArrowDiv"),S(s,"--ax",g[3].x),S(s,"--ay","100%"),B(i,"class","CalloutContainerDiv"),S(i,"width",g[1])},m(t,e){G(t,i,e),u(i,n),u(i,o),u(i,s),u(i,A),d=!0,r||(b=[f(i,"mousedown",g[7]),f(i,"touchstart",g[7]),f(i,"dragstart",g[7])],r=!0)},p(t,e){(!d||8&e)&&S(s,"--ax",t[3].x),(!d||2&e)&&S(i,"width",t[1])},i(n){d||(L((()=>{l&&l.end(1),a=function(g,i,n){const I={direction:"in"};let o,s,A=i(g,{},I),a=!1,l=0;function d(){o&&H(g,o)}function r(){const{delay:i=0,duration:n=300,easing:I=e,tick:C=t,css:r}=A||Ct;r&&(o=k(g,0,1,n,i,I,r,l++)),C(0,1);const u=c()+i,b=u+n;s&&s.abort(),a=!0,L((()=>et(g,!0,"start"))),s=h((t=>{if(a){if(t>=b)return C(1,0),et(g,!0,"end"),d(),a=!1;if(t>=u){const e=I((t-u)/n);C(e,1-e)}}return a}))}let u=!1;return{start(){u||(u=!0,H(g),C(A)?(A=A(I),tt().then(r)):r())},invalidate(){u=!1},end(){a&&(d(),a=!1)}}}(i,g[6]),a.start()})),d=!0)},o(n){a&&a.invalidate(),l=function(g,i,n){const o={direction:"out"};let s,A=i(g,{},o),a=!0;const l=it;function d(){const{delay:i=0,duration:n=300,easing:C=e,tick:o=t,css:d}=A||Ct;d&&(s=k(g,1,0,n,i,C,d));const r=c()+i,u=r+n;L((()=>et(g,!1,"start"))),h((t=>{if(a){if(t>=u)return o(0,1),et(g,!1,"end"),--l.r||I(l.c),!1;if(t>=r){const e=C((t-r)/n);o(1-e,e)}}return a}))}return l.r+=1,C(A)?tt().then((()=>{A=A(o),d()})):d(),{end(t){t&&A.tick&&A.tick(1,0),a&&(s&&H(g,s),a=!1)}}}(i,g[6]),d=!1},d(t){t&&y(i),t&&l&&l.end(),r=!1,I(b)}}}function fe(e){let g,i,n=e[2]&&Re(e);return{c(){g=v("main"),n&&n.c(),this.c=t,S(g,"--ax",e[4].x),S(g,"--ay",e[4].y),S(g,"--halign",e[3].x),S(g,"--valign",e[3].y),S(g,"--borderradius",Xe),S(g,"--arrowpad",`${e[5].value}${e[5].unit}`),S(g,"--backgroundcolor",e[0]),S(g,"--size",`${e[5].value*Math.sqrt(2)}${e[5].unit}`),S(g,"--offsetx","0rem"),S(g,"--offsety",`${e[5].value}${e[5].unit}`)},m(t,e){G(t,g,e),n&&n.m(g,null),i=!0},p(t,[e]){t[2]?n?(n.p(t,e),4&e&&nt(n,1)):(n=Re(t),n.c(),nt(n,1),n.m(g,null)):n&&(it={r:0,c:[],p:it},It(n,1,1,(()=>{n=null})),it.r||I(it.c),it=it.p),(!i||8&e)&&S(g,"--halign",t[3].x),(!i||8&e)&&S(g,"--valign",t[3].y),(!i||1&e)&&S(g,"--backgroundcolor",t[0])},i(t){i||(nt(n),i=!0)},o(t){It(n),i=!1},d(t){t&&y(g),n&&n.d()}}}customElements.get("holdable-button")?console.warn("Skipping re-defining customElement holdable-button"):customElements.define("holdable-button",class extends lt{constructor(t){super(),this.shadowRoot.innerHTML="<style>main{text-align:left;position:relative;pointer-events:auto;cursor:pointer;border-radius:50%;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none !important;-webkit-user-select:none !important}</style>",ct(this,{target:this.shadowRoot,props:Y(this.attributes),customElement:!0},Ve,we,s,{icon:22,capturekey:23,hide:24,size:0,holdscale:25,borderscale:26,iconsize:1,fxsize:2,backgroundcolor:3,iconcolor:4,gradientstop1:5,gradientstop2:6,fxgradientstop1:7,fxgradientstop2:8,customcssurl:9,isbuttonpressed:27},null,[-1,-1]),t&&(t.target&&G(t.target,this,t.anchor),t.props&&(this.$set(t.props),_()))}static get observedAttributes(){return["icon","capturekey","hide","size","holdscale","borderscale","iconsize","fxsize","backgroundcolor","iconcolor","gradientstop1","gradientstop2","fxgradientstop1","fxgradientstop2","customcssurl","isbuttonpressed"]}get icon(){return this.$$.ctx[22]}set icon(t){this.$$set({icon:t}),_()}get capturekey(){return this.$$.ctx[23]}set capturekey(t){this.$$set({capturekey:t}),_()}get hide(){return this.$$.ctx[24]}set hide(t){this.$$set({hide:t}),_()}get size(){return this.$$.ctx[0]}set size(t){this.$$set({size:t}),_()}get holdscale(){return this.$$.ctx[25]}set holdscale(t){this.$$set({holdscale:t}),_()}get borderscale(){return this.$$.ctx[26]}set borderscale(t){this.$$set({borderscale:t}),_()}get iconsize(){return this.$$.ctx[1]}set iconsize(t){this.$$set({iconsize:t}),_()}get fxsize(){return this.$$.ctx[2]}set fxsize(t){this.$$set({fxsize:t}),_()}get backgroundcolor(){return this.$$.ctx[3]}set backgroundcolor(t){this.$$set({backgroundcolor:t}),_()}get iconcolor(){return this.$$.ctx[4]}set iconcolor(t){this.$$set({iconcolor:t}),_()}get gradientstop1(){return this.$$.ctx[5]}set gradientstop1(t){this.$$set({gradientstop1:t}),_()}get gradientstop2(){return this.$$.ctx[6]}set gradientstop2(t){this.$$set({gradientstop2:t}),_()}get fxgradientstop1(){return this.$$.ctx[7]}set fxgradientstop1(t){this.$$set({fxgradientstop1:t}),_()}get fxgradientstop2(){return this.$$.ctx[8]}set fxgradientstop2(t){this.$$set({fxgradientstop2:t}),_()}get customcssurl(){return this.$$.ctx[9]}set customcssurl(t){this.$$set({customcssurl:t}),_()}get isbuttonpressed(){return this.$$.ctx[27]}});let Be=!1,Xe="0rem";function Se(t,e,g){let i,{show:n}=e,{showtime:I=1e4}=e,{backgroundcolor:C="#202020"}=e,{xalign:o="50%"}=e,{width:s="auto"}=e,A=null,a=!1;const c=(l=(t,{duration:e=250})=>({duration:e,css:t=>`\n          clip-path: circle(${100*t}% at ${i.x} 50%);\n        `}),function(t,e){if(!t.hasOwnProperty("ownerDocument")){Object.defineProperty(t,"ownerDocument",{get:function(){return t.parentElement}});let e=t;for(;e.parentElement;)e=e.parentElement;t.parentElement.head=e}return l(0,e)});var l;return t.$$set=t=>{"show"in t&&g(8,n=t.show),"showtime"in t&&g(9,I=t.showtime),"backgroundcolor"in t&&g(0,C=t.backgroundcolor),"xalign"in t&&g(10,o=t.xalign),"width"in t&&g(1,s=t.width)},t.$$.update=()=>{1024&t.$$.dirty&&g(3,i={x:o,y:"100%"}),256&t.$$.dirty&&(t=>{null!==A&&(window.clearTimeout(A),A=null),void 0!==t&&"false"!==t?A=window.setTimeout((()=>{g(2,a=!0),A=null,I>0&&(A=window.setTimeout((()=>{g(2,a=!1),A=null}),I))}),500):g(2,a=!1)})(n)},[C,s,a,i,{x:"50%",y:"10%"},{value:.55,unit:"rem"},c,t=>{t.preventDefault(),t.stopPropagation(),g(2,a=!1)},n,I,o]}customElements.get("call-out")?console.warn("Skipping re-defining customElement call-out"):customElements.define("call-out",class extends lt{constructor(t){super(),this.shadowRoot.innerHTML="<style>main{margin:0;padding:0}.CalloutContainerDiv{position:absolute;left:var(--ax);top:var(--ay);transform:translate(calc(-1 * var(--halign)), calc(-1 * var(--valign)));padding:var(--arrowpad);z-index:10;pointer-events:auto}.CalloutDiv{position:relative;box-sizing:border-box;min-width:8rem;border-radius:var(--borderradius);padding:0.50rem 1rem;background-color:var(--backgroundcolor);text-align:center;user-select:none;z-index:10}.useShadow{box-shadow:0 0.2rem 0.5rem #00000040}.ArrowDiv{position:absolute;left:calc(var(--ax) - var(--offsetx));top:calc(var(--ay) - var(--offsety));transform:translate(-50%, -50%) rotate(45deg);width:var(--size);height:var(--size);background-color:var(--backgroundcolor);z-index:10}.ArrowShadowDiv{position:absolute;left:calc(var(--ax) - var(--offsetx));top:calc(var(--ay) - var(--offsety));transform:translate(-50%, -50%) rotate(45deg);width:var(--size);height:var(--size);background-color:var(--backgroundcolor);background-color:#00000000;box-shadow:0 0.2rem 0.5rem #00000040;z-index:9}</style>",ct(this,{target:this.shadowRoot,props:Y(this.attributes),customElement:!0},Se,fe,s,{show:8,showtime:9,backgroundcolor:0,xalign:10,width:1},null),t&&(t.target&&G(t.target,this,t.anchor),t.props&&(this.$set(t.props),_()))}static get observedAttributes(){return["show","showtime","backgroundcolor","xalign","width"]}get show(){return this.$$.ctx[8]}set show(t){this.$$set({show:t}),_()}get showtime(){return this.$$.ctx[9]}set showtime(t){this.$$set({showtime:t}),_()}get backgroundcolor(){return this.$$.ctx[0]}set backgroundcolor(t){this.$$set({backgroundcolor:t}),_()}get xalign(){return this.$$.ctx[10]}set xalign(t){this.$$set({xalign:t}),_()}get width(){return this.$$.ctx[1]}set width(t){this.$$set({width:t}),_()}});const Ne=()=>{const t=K();return(e,g)=>{t.dispatchEvent(new CustomEvent(e,{detail:g,composed:!0}))}},{document:Ye,window:ze}=ot;function xe(t){let e;return{c(){e=v("link"),B(e,"href","https://fonts.googleapis.com/css2?family=Saira+Condensed:wght@700&display=swap"),B(e,"rel","stylesheet")},m(t,g){G(t,e,g)},d(t){t&&y(e)}}}function Fe(e){let g,i,n,C,o,s,A,a,c=e[25]&&xe();return{c(){c&&c.c(),g=R(),i=V(),n=v("holdable-button"),C=v("call-out"),o=w(e[24]),this.c=t,X(C,"width",e[7]),X(C,"xalign",e[6]),X(C,"show",s=""!==e[24]&&e[22]&&!e[1]?"true":"false"),X(C,"showtime",e[5]),X(C,"backgroundcolor",e[16]),N(C,"defaultTypography",e[25]),X(n,"size",e[3]),X(n,"icon",e[23]),X(n,"capturekey",e[0]),X(n,"gradientstop1",e[10]),X(n,"gradientstop2",e[11]),X(n,"fxgradientstop1",e[12]),X(n,"fxgradientstop2",e[13]),X(n,"hide",e[1]),X(n,"backgroundcolor",e[8]),X(n,"iconcolor",e[9]),X(n,"holdscale",e[17]),X(n,"borderscale",e[18]),X(n,"iconsize",e[19]),X(n,"fxsize",e[20]),X(n,"customcssurl",e[21]),S(n,"--voffset",e[4]),S(n,"--size",e[3]),S(n,"--textcolor",e[15]),S(n,"--fontsize",e[14]),N(n,"placementBottom","bottom"===e[2])},m(t,I){c&&c.m(Ye.head,null),u(Ye.head,g),G(t,i,I),G(t,n,I),u(n,C),u(C,o),A||(a=[f(ze,"message",e[28]),f(n,"holdstart",e[26]),f(n,"holdend",e[27])],A=!0)},p(t,e){t[25]?c||(c=xe(),c.c(),c.m(g.parentNode,g)):c&&(c.d(1),c=null),16777216&e[0]&&function(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}(o,t[24]),128&e[0]&&X(C,"width",t[7]),64&e[0]&&X(C,"xalign",t[6]),20971522&e[0]&&s!==(s=""!==t[24]&&t[22]&&!t[1]?"true":"false")&&X(C,"show",s),32&e[0]&&X(C,"showtime",t[5]),65536&e[0]&&X(C,"backgroundcolor",t[16]),33554432&e[0]&&N(C,"defaultTypography",t[25]),8&e[0]&&X(n,"size",t[3]),8388608&e[0]&&X(n,"icon",t[23]),1&e[0]&&X(n,"capturekey",t[0]),1024&e[0]&&X(n,"gradientstop1",t[10]),2048&e[0]&&X(n,"gradientstop2",t[11]),4096&e[0]&&X(n,"fxgradientstop1",t[12]),8192&e[0]&&X(n,"fxgradientstop2",t[13]),2&e[0]&&X(n,"hide",t[1]),256&e[0]&&X(n,"backgroundcolor",t[8]),512&e[0]&&X(n,"iconcolor",t[9]),131072&e[0]&&X(n,"holdscale",t[17]),262144&e[0]&&X(n,"borderscale",t[18]),524288&e[0]&&X(n,"iconsize",t[19]),1048576&e[0]&&X(n,"fxsize",t[20]),2097152&e[0]&&X(n,"customcssurl",t[21]),16&e[0]&&S(n,"--voffset",t[4]),8&e[0]&&S(n,"--size",t[3]),32768&e[0]&&S(n,"--textcolor",t[15]),16384&e[0]&&S(n,"--fontsize",t[14]),4&e[0]&&N(n,"placementBottom","bottom"===t[2])},i:t,o:t,d(t){c&&c.d(t),y(g),t&&y(i),t&&y(n),A=!1,I(a)}}}function ke(t,e,g){let i,n;var I=this&&this.__awaiter||function(t,e,g,i){return new(g||(g=Promise))((function(n,I){function C(t){try{s(i.next(t))}catch(t){I(t)}}function o(t){try{s(i.throw(t))}catch(t){I(t)}}function s(t){var e;t.done?n(t.value):(e=t.value,e instanceof g?e:new g((function(t){t(e)}))).then(C,o)}s((i=i.apply(t,e||[])).next())}))};const C=Ne();let o,{projectid:s}=e,{appid:A}=e,{apiurl:a}=e,{capturekey:c=" "}=e,{poweron:l="auto"}=e,{hide:d}=e,{taptotalktime:r=8e3}=e,{silencetohanguptime:h=1e3}=e,{placement:u}=e,{size:b="80px"}=e,{voffset:p="40px"}=e,{intro:m="Hold to talk"}=e,{hint:Z="Hold to talk"}=e,{showtime:G=1e4}=e,{hintxalign:y="50%"}=e,{hintwidth:v="auto"}=e,{backgroundcolor:W="#ffffff"}=e,{iconcolor:w="#000000"}=e,{gradientstop1:V="#15e8b5"}=e,{gradientstop2:R="#4fa1f9"}=e,{fxgradientstop1:f}=e,{fxgradientstop2:B}=e,{fontsize:X="1.0rem"}=e,{textcolor:S="#ffffff"}=e,{hintbackgroundcolor:N="#202020"}=e,{holdscale:Y="1.35"}=e,{borderscale:z="0.075"}=e,{iconsize:x="60%"}=e,{fxsize:F="250%"}=e,{customcssurl:k}=e,{customtypography:H}=e,J=!1,K=!1,E=!1,U=!1,M=!1,D=null,$=null,Q=Yt.Disconnected,L=null,O=null,j=Yt.Disconnected,P=wt.Stopped,_=null;T((()=>{switch(M=!0,l){case"true":J=!0;break;case"auto":q(document.querySelector("intro-popup"))}tt(s,A)}));const q=t=>{null===_&&null!==t&&(_=t,t.addEventListener(Ie.requeststartmicrophone,(()=>I(void 0,void 0,void 0,(function*(){yield L.initialize(),yield O.initialize(),yield L.attach(O.mediaStream)})))),J=null===localStorage.getItem(ne.SpeechlyFirstConnect))},tt=(t,e)=>{if(M&&!L&&(t||e)){const i=Object.assign(Object.assign(Object.assign({connect:!1},e&&!t&&{appId:e}),t&&{projectId:t}),a&&{apiUrl:a});L=new ae(i),L.onStateChange(nt),L.onSegmentChange((t=>{D&&et(h),C(Ie.speechsegment,t),window.postMessage({type:Ie.speechsegment,segment:t},"*")})),O=new Bt,O.onStateChange(It),L.initialize(),g(22,U=!0)}},et=t=>{D&&window.clearTimeout(D),D=window.setTimeout((()=>{D=null,gt()}),t)},gt=()=>{L&&(L.stop(),C(Ie.stopcontext)),it()},it=()=>{switch(P){case wt.NoAudioConsent:case wt.NoBrowserSupport:g(23,Q=P);break;default:g(23,Q=j)}},nt=t=>{j=t,it(),window.postMessage({type:Ie.speechstate,state:t},"*"),Ct()},It=t=>{P=t,window.postMessage({type:Ie.audiosourcestate,state:t},"*"),Ct(),it()},Ct=()=>{void 0===o&&j===Yt.Connected&&P===wt.Started&&(o=!0,J=!1,null===localStorage.getItem(ne.SpeechlyFirstConnect)&&localStorage.setItem(ne.SpeechlyFirstConnect,String(Date.now())))};return t.$$set=t=>{"projectid"in t&&g(29,s=t.projectid),"appid"in t&&g(30,A=t.appid),"apiurl"in t&&g(31,a=t.apiurl),"capturekey"in t&&g(0,c=t.capturekey),"poweron"in t&&g(32,l=t.poweron),"hide"in t&&g(1,d=t.hide),"taptotalktime"in t&&g(33,r=t.taptotalktime),"silencetohanguptime"in t&&g(34,h=t.silencetohanguptime),"placement"in t&&g(2,u=t.placement),"size"in t&&g(3,b=t.size),"voffset"in t&&g(4,p=t.voffset),"intro"in t&&g(35,m=t.intro),"hint"in t&&g(36,Z=t.hint),"showtime"in t&&g(5,G=t.showtime),"hintxalign"in t&&g(6,y=t.hintxalign),"hintwidth"in t&&g(7,v=t.hintwidth),"backgroundcolor"in t&&g(8,W=t.backgroundcolor),"iconcolor"in t&&g(9,w=t.iconcolor),"gradientstop1"in t&&g(10,V=t.gradientstop1),"gradientstop2"in t&&g(11,R=t.gradientstop2),"fxgradientstop1"in t&&g(12,f=t.fxgradientstop1),"fxgradientstop2"in t&&g(13,B=t.fxgradientstop2),"fontsize"in t&&g(14,X=t.fontsize),"textcolor"in t&&g(15,S=t.textcolor),"hintbackgroundcolor"in t&&g(16,N=t.hintbackgroundcolor),"holdscale"in t&&g(17,Y=t.holdscale),"borderscale"in t&&g(18,z=t.borderscale),"iconsize"in t&&g(19,x=t.iconsize),"fxsize"in t&&g(20,F=t.fxsize),"customcssurl"in t&&g(21,k=t.customcssurl),"customtypography"in t&&g(37,H=t.customtypography)},t.$$.update=()=>{16&t.$$.dirty[1]&&g(24,i=m),1610612736&t.$$.dirty[0]&&tt(s,A),64&t.$$.dirty[1]&&g(25,n=void 0===H||"false"===H)},[c,d,u,b,p,G,y,v,W,w,V,R,f,B,X,S,N,Y,z,x,F,k,U,Q,i,n,t=>I(void 0,void 0,void 0,(function*(){$=I(void 0,void 0,void 0,(function*(){if(g(22,U=!1),D&&(window.clearTimeout(D),D=null),L){if(J)window.postMessage({type:Ie.speechlypoweron},"*");else if(j>=Yt.Connected&&P===wt.Started)K=!0;else if(A||s)try{const t=Date.now();yield L.initialize(),yield O.initialize(),yield L.attach(O.mediaStream),K=Date.now()-t<1500}catch(t){console.error("Speechly initialization failed - ",t),K=!1}else console.warn("No appid/projectid attribute specified. Speechly voice services are unavailable.");K&&(E=L.isActive(),L.isActive()||(C(Ie.startcontext),L.start(A)))}window.postMessage({type:Ie.holdstart,state:j,audioSourceState:P},"*")}))})),t=>I(void 0,void 0,void 0,(function*(){yield $,L&&K&&(K=!1,t.detail.timeMs<600?0==r?(gt(),g(24,i=Z),g(22,U=!0)):E?gt():et(r):gt()),window.postMessage({type:Ie.holdend},"*")})),t=>{switch(t.data.type){case Ie.showhint:g(24,i=t.data.hint),g(22,U=!0);break;case Ie.speechlyintroready:"auto"===l&&q(document.querySelector("intro-popup"))}},s,A,a,l,r,h,m,Z,H]}customElements.get("push-to-talk-button")?console.warn("Skipping re-defining customElement push-to-talk-button"):customElements.define("push-to-talk-button",class extends lt{constructor(t){super(),this.shadowRoot.innerHTML="<style>.placementBottom{position:fixed;bottom:0;left:0;right:0;height:calc(var(--size) + var(--voffset));max-height:100vh;pointer-events:none;display:flex;flex-direction:row;justify-content:center;z-index:50}call-out.defaultTypography{font-family:'Saira Condensed', sans-serif;color:var(--textcolor);font-size:var(--fontsize);line-height:120%;text-transform:uppercase}</style>",ct(this,{target:this.shadowRoot,props:Y(this.attributes),customElement:!0},ke,Fe,s,{projectid:29,appid:30,apiurl:31,capturekey:0,poweron:32,hide:1,taptotalktime:33,silencetohanguptime:34,placement:2,size:3,voffset:4,intro:35,hint:36,showtime:5,hintxalign:6,hintwidth:7,backgroundcolor:8,iconcolor:9,gradientstop1:10,gradientstop2:11,fxgradientstop1:12,fxgradientstop2:13,fontsize:14,textcolor:15,hintbackgroundcolor:16,holdscale:17,borderscale:18,iconsize:19,fxsize:20,customcssurl:21,customtypography:37},null,[-1,-1]),t&&(t.target&&G(t.target,this,t.anchor),t.props&&(this.$set(t.props),_()))}static get observedAttributes(){return["projectid","appid","apiurl","capturekey","poweron","hide","taptotalktime","silencetohanguptime","placement","size","voffset","intro","hint","showtime","hintxalign","hintwidth","backgroundcolor","iconcolor","gradientstop1","gradientstop2","fxgradientstop1","fxgradientstop2","fontsize","textcolor","hintbackgroundcolor","holdscale","borderscale","iconsize","fxsize","customcssurl","customtypography"]}get projectid(){return this.$$.ctx[29]}set projectid(t){this.$$set({projectid:t}),_()}get appid(){return this.$$.ctx[30]}set appid(t){this.$$set({appid:t}),_()}get apiurl(){return this.$$.ctx[31]}set apiurl(t){this.$$set({apiurl:t}),_()}get capturekey(){return this.$$.ctx[0]}set capturekey(t){this.$$set({capturekey:t}),_()}get poweron(){return this.$$.ctx[32]}set poweron(t){this.$$set({poweron:t}),_()}get hide(){return this.$$.ctx[1]}set hide(t){this.$$set({hide:t}),_()}get taptotalktime(){return this.$$.ctx[33]}set taptotalktime(t){this.$$set({taptotalktime:t}),_()}get silencetohanguptime(){return this.$$.ctx[34]}set silencetohanguptime(t){this.$$set({silencetohanguptime:t}),_()}get placement(){return this.$$.ctx[2]}set placement(t){this.$$set({placement:t}),_()}get size(){return this.$$.ctx[3]}set size(t){this.$$set({size:t}),_()}get voffset(){return this.$$.ctx[4]}set voffset(t){this.$$set({voffset:t}),_()}get intro(){return this.$$.ctx[35]}set intro(t){this.$$set({intro:t}),_()}get hint(){return this.$$.ctx[36]}set hint(t){this.$$set({hint:t}),_()}get showtime(){return this.$$.ctx[5]}set showtime(t){this.$$set({showtime:t}),_()}get hintxalign(){return this.$$.ctx[6]}set hintxalign(t){this.$$set({hintxalign:t}),_()}get hintwidth(){return this.$$.ctx[7]}set hintwidth(t){this.$$set({hintwidth:t}),_()}get backgroundcolor(){return this.$$.ctx[8]}set backgroundcolor(t){this.$$set({backgroundcolor:t}),_()}get iconcolor(){return this.$$.ctx[9]}set iconcolor(t){this.$$set({iconcolor:t}),_()}get gradientstop1(){return this.$$.ctx[10]}set gradientstop1(t){this.$$set({gradientstop1:t}),_()}get gradientstop2(){return this.$$.ctx[11]}set gradientstop2(t){this.$$set({gradientstop2:t}),_()}get fxgradientstop1(){return this.$$.ctx[12]}set fxgradientstop1(t){this.$$set({fxgradientstop1:t}),_()}get fxgradientstop2(){return this.$$.ctx[13]}set fxgradientstop2(t){this.$$set({fxgradientstop2:t}),_()}get fontsize(){return this.$$.ctx[14]}set fontsize(t){this.$$set({fontsize:t}),_()}get textcolor(){return this.$$.ctx[15]}set textcolor(t){this.$$set({textcolor:t}),_()}get hintbackgroundcolor(){return this.$$.ctx[16]}set hintbackgroundcolor(t){this.$$set({hintbackgroundcolor:t}),_()}get holdscale(){return this.$$.ctx[17]}set holdscale(t){this.$$set({holdscale:t}),_()}get borderscale(){return this.$$.ctx[18]}set borderscale(t){this.$$set({borderscale:t}),_()}get iconsize(){return this.$$.ctx[19]}set iconsize(t){this.$$set({iconsize:t}),_()}get fxsize(){return this.$$.ctx[20]}set fxsize(t){this.$$set({fxsize:t}),_()}get customcssurl(){return this.$$.ctx[21]}set customcssurl(t){this.$$set({customcssurl:t}),_()}get customtypography(){return this.$$.ctx[37]}set customtypography(t){this.$$set({customtypography:t}),_()}})})?i.call(e,g,e,t):i)||(t.exports=n)}},e={};function g(i){var n=e[i];if(void 0!==n)return n.exports;var I=e[i]={exports:{}};return t[i](I,I.exports,g),I.exports}g.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return g.d(e,{a:e}),e},g.d=(t,e)=>{for(var i in e)g.o(e,i)&&!g.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},g.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),g.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{"use strict";g(234);class t extends HTMLElement{constructor(){super(),this._shadow=this.attachShadow({mode:"open"}),this._shadow.appendChild((()=>{const t=document.createElement("style");return t.textContent="\n    main {\n      display: flex;\n      flex-direction: row;\n      justify-content: center;\n      align-items: center;\n      margin: 0;\n      padding: 0;\n    }\n\n    #bot {\n      border: 1px solid #ccc;\n      width: 36rem;\n      background-color: rgb(30,121,141);\n      border-radius: 2rem;\n    }\n\n    #questionContainer {\n      display: flex;\n      flex-direction: row;\n      width: 100%;\n      margin: 0 0 0 0;\n      position: relative;\n    }\n\n    #question {\n      width: 100%;\n      font-family: Verdana;\n      font-size: 1.5rem;\n      border: 1px solid #ccc;\n      padding: 0.5rem 0.5rem 0.5rem 3rem;\n      border-radius: 4em;\n      background-color: #fff;\n    }\n\n    #question:focus {\n      outline: none !important;\n      box-shadow: 0 0 10px #fff;\n    }\n\n    ::placeholder {\n      color: #aaa;\n      opacity: 1;\n    }\n\n    .startAdornment {\n      position: absolute;\n      left: 0;\n      top: 0;\n      bottom: 0;\n      display: flex;\n      flex-direction: row;\n      justify-content: center;\n      align-items: center;\n      color: #aaa;\n      padding: 0.5rem;\n      font-size: 1.75rem;\n    }\n\n    .endAdornment {\n      position: absolute;\n      right: 0.1rem;\n      top: 0;\n      bottom: 0;\n      display: flex;\n      flex-direction: row;\n      justify-content: center;\n      align-items: center;\n      color: #aaa;\n      padding: 0rem;\n    }\n\n    #answer {\n      display: block;\n      padding: 5px 32px;\n      font-size: 18px;\n      font-family: Verdana;\n      font-weight: normal;\n      font-style: normal;\n      color: #fff;\n      line-height: 1.5;\n    }\n\n    #error {\n      display: block;\n      padding: 5px 32px;\n      font-size: 18px;\n      font-family: Verdana\n      font-weight: normal;\n      font-style: normal;\n      color: #f08989;\n      line-height: 1.5;\n    }\n    .QCzoEc {\n      display: inline-block;\n      margin-top: 3px;\n      color: #9aa0a6;\n      position: relative;\n    }\n\n    #loader {\n      display: none;\n      margin: auto;\n    }\n  ",t})()),this._shadow.appendChild((()=>{const t=document.createElement("main");return t.innerHTML='<div id="bot">\n    <div id="questionContainer">\n      <input id="question" type="text" placeholder="Ask the bot..." autofocus>\n      <div class="startAdornment">\n      <span class="QCzoEc" style="height:2rem;line-height:20px;width:2rem"><svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg></span>\n      </div>\n      <push-to-talk-button id="microphoneButton" size="2.8rem" class="endAdornment" fontsize="0.90rem" backgroundcolor="#104864" intro="Tap or hold for voice search" showtime="30000" appid="f6682864-81dd-4e5c-baf6-b4ef92cd89f5"/>\n    </div>\n    <div id="answerContainer">\n      <div id="div-error">\n        <p>\n          <span id="error"></span>\n        </p>\n      </div>\n      <div id="div-answer">\n        <p>\n          <span id="answer"></span>\n        </p>\n      </div>\n      <svg\n        id="loader"\n        xmlns="http://www.w3.org/2000/svg"\n        xmlns:xlink="http://www.w3.org/1999/xlink"\n        width="150px"\n        height="45px"\n        viewBox="0 0 100 30"\n        preserveAspectRatio="xMidYMid"\n      >\n        <g transform="translate(20 15)">\n          <circle cx="0" cy="0" r="6" fill="#e15b64">\n            <animateTransform\n              attributeName="transform"\n              type="scale"\n              begin="-0.375s"\n              calcMode="spline"\n              keySplines="0.3 0 0.7 1;0.3 0 0.7 1"\n              values="0;1;0"\n              keyTimes="0;0.5;1"\n              dur="1s"\n              repeatCount="indefinite"\n            ></animateTransform>\n          </circle>\n        </g>\n        <g transform="translate(40 15)">\n          <circle cx="0" cy="0" r="6" fill="#f8b26a">\n            <animateTransform\n              attributeName="transform"\n              type="scale"\n              begin="-0.25s"\n              calcMode="spline"\n              keySplines="0.3 0 0.7 1;0.3 0 0.7 1"\n              values="0;1;0"\n              keyTimes="0;0.5;1"\n              dur="1s"\n              repeatCount="indefinite"\n            ></animateTransform>\n          </circle>\n        </g>\n        <g transform="translate(60 15)">\n          <circle cx="0" cy="0" r="6" fill="#abbd81">\n            <animateTransform\n              attributeName="transform"\n              type="scale"\n              begin="-0.125s"\n              calcMode="spline"\n              keySplines="0.3 0 0.7 1;0.3 0 0.7 1"\n              values="0;1;0"\n              keyTimes="0;0.5;1"\n              dur="1s"\n              repeatCount="indefinite"\n            ></animateTransform>\n          </circle>\n        </g>\n        <g transform="translate(80 15)">\n          <circle cx="0" cy="0" r="6" fill="#81a3bd">\n            <animateTransform\n              attributeName="transform"\n              type="scale"\n              begin="0s"\n              calcMode="spline"\n              keySplines="0.3 0 0.7 1;0.3 0 0.7 1"\n              values="0;1;0"\n              keyTimes="0;0.5;1"\n              dur="1s"\n              repeatCount="indefinite"\n            ></animateTransform>\n          </circle>\n        </g>\n      </svg>\n    </div>\n  </div>',t})()),this._chatHistory=[],this.question="",this.answer="",this.error=""}connectedCallback(){this._shadow.getElementById("question").addEventListener("focus",(t=>{this._shadow.getElementById("answerContainer").style.display="block"})),this._shadow.getElementById("question").addEventListener("blur",(t=>{this._shadow.getElementById("answerContainer").style.display="none"})),this._shadow.getElementById("microphoneButton").addEventListener("speechsegment",(t=>{const e=t.detail.words.filter((t=>t.value)).map((t=>t.value.toLowerCase())).join(" ");this._shadow.getElementById("question").value=e,t.detail.isFinal&&this.handleRequest(e)})),this._shadow.getElementById("question").addEventListener("keyup",(t=>{"Enter"===t.key&&this.handleRequest(t.target.value)}))}async handleRequest(t){this._shadow.getElementById("loader").style.display="block";const e=await async function(t,e,g){return(await fetch(`https://bots.datacakes.ai/bot/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q:e,chat_history:g})})).json()}(this.botId,t,this.chatHistory);this._shadow.getElementById("loader").style.display="none","ok"==e.status?(this.question=e.data.question,this.answer=e.data.answer,this.error="",this.chatHistory=[this.question,this.answer]):"error"==e.status&&(this.answer="",this.error=e.message),this.render()}static get observedAttributes(){return["bot-id"]}attributeChangedCallback(t,e,g){"bot-id"===t&&(this.question="",this.answer="",this.error="",this.botId=g,this._chatHistory=[],this.render())}set chatHistory(t){this._chatHistory.push(t),this._chatHistory.length>10&&this._chatHistory.splice(0,this._chatHistory.length-10)}get chatHistory(){return this._chatHistory}render(){this._shadow.getElementById("question").value=this.question,this.answer.trim().length?(this._shadow.getElementById("div-answer").style.display="block",this._shadow.getElementById("answer").innerText=this.answer):this._shadow.getElementById("div-answer").style.display="none",this.error.trim().length?(this._shadow.getElementById("div-error").style.display="block",this._shadow.getElementById("error").innerText=this.error):this._shadow.getElementById("div-error").style.display="none"}}customElements.define("datacakes-bot",t)})()})();